---
title: "Symbiont dominance: when does a standard sensitive or tolerant symbiont dominate the host?"
author: "Ross Cunning and Alexandra Brown"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
      html_document:
            code_folding: hide
---

```{r}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, fig.width=8, fig.height=8, results='hold')

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")
library("MASS")
library("plot3D")
library("adegenet")

options(repr.plot.res=240)
```

```{r}
# A function for detecting when the host growth rate changes sign

detect_gr_change <- function(run) {
    prevGr <- run$dH.Hdt[1:length(run$dH.Hdt)-1]
    currGr <- run$dH.Hdt[2:length(run$dH.Hdt)]
    changelist <- ((run$time[2:length(run$time)] + run$time[1:length(run$time)-1])/2)[prevGr*currGr<= 0]
    if (length(changelist) > 0) {
          return(changelist[length(changelist)])
   }
   return(NA)
}
```

## Set symbiont parameters

```{r}
# parameters for single-symbiont simulations
# sensitive symb. parameters
pars_sen <- def_pars(nsym=1)
pars_sen$initS <- 1

# tolerant symb. parameters
pars_tol <- def_pars(nsym=1)
pars_tol$jCPm <- 1.0
pars_tol$kROS <- 250
pars_tol$jSGm <- 0.15
pars_tol$initS <- 1

# parameters for two-symbiont simulations
# sensitive symbiont is symbiont 1; tolerant is symbiont 2
pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5, 0.5)
```

# Simulate healthy corals with sensitive and tolerant symbionts alone and together

The goal is to find out

1. Under which conditions can the symbionts survive (separately or together)?
2. When both symbionts are present, which one dominates the host?

```{r, cache=TRUE}

# Code for run_coral, so we can make sure the updated version was used
body(coRal::run_coral)

# run simulations for 600 days
time<-seq(1, 600, 0.1)

search_params <- expand.grid("L"=seq(0, 40, length.out=11),       # Light, choose values between 0 and 40
                            "N"=seq(1e-7, 3.9e-6, length.out=11),     # DIN, choose values between 0 and 4e-6
                            "X" = seq(0, 4e-7, length.out=11),     # Food, choose values between 0 and 4e07)
                            "kCO2" = seq(10, 40, length.out=11))    

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- coRal::run_coral(time=time, env=env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- coRal::run_coral(time=time, env=env, pars=replace(pars_tol, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- coRal::run_coral(time=time, env=env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"], "X"=search_params[i, "X"],
    "kCO2"=search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
healthy_sims <- data.frame(results, row.names=NULL)
```

```{r}
# set the columns to their proper types
healthy_sims <- transform(healthy_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```


## Same kind of simulations as before, but with randomly chosen points (to make DAPC plot look nicer)

```{r, cache=TRUE}

# Code for run_coral, so we can make sure the updated version was used
body(coRal::run_coral)

# run simulations for 600 days
time<-seq(1, 600, 0.1)

search_params <- data.frame("L"=runif(20000, 5, 40),       # Light, choose values between 5 and 40
                            "N"=runif(20000, 1e-7, 6e-6),     # DIN, choose values between 0 and 6e-6
                            "X" = runif(20000, 0, 4e-7),     # Food, choose values between 0 and 4e07
                            "kCO2" = runif(20000, 10, 40))   # Host carbon-concentrating ability, choose values between 10 and 40

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- coRal::run_coral(time=time, env=env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- coRal::run_coral(time=time, env=env, pars=replace(pars_tol, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- coRal::run_coral(time=time, env=env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"], "X"=search_params[i, "X"],
    "kCO2"=search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
rand_healthy_sims <- data.frame(results, row.names=NULL)
```

```{r}
# set the columns to their proper types
rand_healthy_sims <- transform(rand_healthy_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```

# Which symbiont dominates the host where?

```{r}

# Set up the matrices that will be plotted
plot_L_N <- matrix(0, nrow=length(unique(healthy_sims$N)), ncol=length(unique(healthy_sims$L)),
      dimnames=list(unique(healthy_sims$N), unique(healthy_sims$L)))

plot_L_X <- matrix(0, nrow=length(unique(healthy_sims$X)), ncol=length(unique(healthy_sims$L)),
      dimnames=list(unique(healthy_sims$X), unique(healthy_sims$L)))

plot_L_kCO2 <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$L)),
      dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$L)))

plot_N_X <- matrix(0, nrow=length(unique(healthy_sims$X)), ncol=length(unique(healthy_sims$N)),
      dimnames=list(unique(healthy_sims$X), unique(healthy_sims$N)))

plot_N_kCO2 <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$N)),
      dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$N)))

plot_X_kCO2 <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$X)),
      dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$X)))


# For each combination of environmental/host parameters, average the tolerant: sensitive symbiont ratio
for (i in 1:length(unique(healthy_sims$N))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_N[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$N == unique(healthy_sims$N)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))

                  # if sumplot_L_N[[i, j]] == 0) {
                  #       plot_L_N[[i, j]] <- NA
                  # }
      }
}

for (i in 1:length(unique(healthy_sims$X))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_X[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$X == unique(healthy_sims$X)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))

                  # if (plot_L_X[[i, j]] == 0) {
                  #       plot_L_X[[i, j]] <- NA
                  # }
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_kCO2[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))
                  #
                  # if (plot_L_kCO2[[i, j]] == 0) {
                  #       plot_L_kCO2[[i, j]] <- NA
                  # }
      }
}

for (i in 1:length(unique(healthy_sims$X))) {
      for (j in 1:length(unique(healthy_sims$N))) {
            plot_N_X[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$X == unique(healthy_sims$X)[[i]]) & (healthy_sims$N == unique(healthy_sims$N)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))

      #             if (plot_N_X[[i, j]] == 0) {
      #                   plot_N_X[[i, j]] <- NA
      #             }
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$N))) {
            plot_N_kCO2[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$N == unique(healthy_sims$N)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))

                  # if (plot_N_kCO2[[i, j]] == 0) {
                  #       plot_N_kCO2[[i, j]] <- NA
                  # }
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$X))) {
            plot_X_kCO2[[i, j]] <-
                  log(mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$X == unique(healthy_sims$X)[[j]]) &
                        healthy_sims$survival_both, "tol_per_sen"]))

            # if (plot_X_kCO2[[i, j]] == 0) {
            #       plot_X_kCO2[[i, j]] <- NA
            # }
      }
}


# Make the plots
par(mfrow=c(3, 3))
plot(plot_L_N[nrow(plot_L_N):1,],
      xlab="Light", ylab="Nitrogen", main="Average Tol:Sen ratio \n Light vs nitrogen",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)
plot(plot_L_X[nrow(plot_L_X):1,],
      xlab="Light", ylab="Food", main="Average Tol:Sen ratio \n Light vs food",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)
plot(plot_L_kCO2[nrow(plot_L_kCO2):1,],
      xlab="Light", ylab="kCO2", main="Average Tol:Sen ratio \n Light vs kCO2",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)

plot(plot_N_X[nrow(plot_N_X):1,],
      xlab="Nitrogen", ylab="Food", main="Average Tol:Sen ratio \n Nitrogen vs food",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)
plot(plot_N_kCO2[nrow(plot_N_kCO2):1,],
      xlab="Nitrogen", ylab="kCO2", main="Average Tol:Sen ratio \n Nitrogen vs kCO2",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)
plot(plot_X_kCO2[nrow(plot_X_kCO2):1,],
      xlab="Food", ylab="kCO2", main="Average Tol:Sen ratio \n Food vs kCO2",
      #breaks=seq(min(log(healthy_sims$tol_per_sen)), max(log(healthy_sims$tol_per_sen)), length.out=11), col=viridis(10), na.col="grey", key=NULL)
      breaks=seq(-50, 50, length.out=11), col=viridis(10), na.col="grey", key=NULL)

# Legend
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1, main="log(Tol:Sen ratio)\naveraged over cases\nwhere host survives")

legend("top", legend=c("Host dies",
# paste(round(seq(min(log(healthy_sims$tol_per_sen)),
# max(log(healthy_sims$tol_per_sen))-(max(log(healthy_sims$tol_per_sen))-min(log(healthy_sims$tol_per_sen)))/10, length.out=10),0),
# round(seq(min(log(healthy_sims$tol_per_sen)) + (max(log(healthy_sims$tol_per_sen))-min(log(healthy_sims$tol_per_sen)))/10, max(log(healthy_sims$tol_per_sen)), length.out=10),0),
paste(seq(-50, 40, length.out=10), seq(-40, 50, length.out=10),
sep=" to ")), fill=c("grey", viridis(10)), cex=1, ncol=2)
```

### 1c. Where do hosts with both symbionts survive?

```{r}

# Set up the matrices that will be plotted
plot_L_N_survival_both <- matrix(0, nrow=length(unique(healthy_sims$N)), ncol=length(unique(healthy_sims$L)),
      dimnames=list(unique(healthy_sims$N), unique(healthy_sims$L)))

plot_L_X_survival_both <- matrix(0, nrow=length(unique(healthy_sims$X)), ncol=length(unique(healthy_sims$L)),
      dimnames=list(unique(healthy_sims$X), unique(healthy_sims$L)))

 plot_L_kCO2_survival_both <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$L)),
       dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$L)))

plot_N_X_survival_both <- matrix(0, nrow=length(unique(healthy_sims$X)), ncol=length(unique(healthy_sims$N)),
      dimnames=list(unique(healthy_sims$X), unique(healthy_sims$N)))

plot_N_kCO2_survival_both <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$N)),
      dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$N)))

plot_X_kCO2_survival_both <- matrix(0, nrow=length(unique(healthy_sims$kCO2)), ncol=length(unique(healthy_sims$X)),
      dimnames=list(unique(healthy_sims$kCO2), unique(healthy_sims$X)))


# For each combination of environmental/host parameters, find the fraction of simulations that resulted in host survival            
for (i in 1:length(unique(healthy_sims$N))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_N_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$N == unique(healthy_sims$N)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]), "survival_both"])
      }
}

for (i in 1:length(unique(healthy_sims$X))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_X_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$X == unique(healthy_sims$X)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]), "survival_both"])
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$L))) {
            plot_L_kCO2_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$L == unique(healthy_sims$L)[[j]]), "survival_both"])
      }
}

for (i in 1:length(unique(healthy_sims$X))) {
      for (j in 1:length(unique(healthy_sims$N))) {
            plot_N_X_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$X == unique(healthy_sims$X)[[i]]) & (healthy_sims$N == unique(healthy_sims$N)[[j]]), "survival_both"])
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$N))) {
            plot_N_kCO2_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$N == unique(healthy_sims$N)[[j]]), "survival_both"])
      }
}

for (i in 1:length(unique(healthy_sims$kCO2))) {
      for (j in 1:length(unique(healthy_sims$X))) {
            plot_X_kCO2_survival_both[[i, j]] <-
                  mean(healthy_sims[(healthy_sims$kCO2 == unique(healthy_sims$kCO2)[[i]]) & (healthy_sims$X == unique(healthy_sims$X)[[j]]), "survival_both"])
      }
}


# Make the plots
par(mfrow=c(3, 3))
plot(plot_L_N_survival_both[nrow(plot_L_N_survival_both):1,],
      xlab="Light", ylab="Nitrogen", main="Host survival (both symbs)\n Light vs nitrogen",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)
plot(plot_L_X_survival_both[nrow(plot_L_X_survival_both):1,],
      xlab="Light", ylab="Food", main="Host survival (both symbs)\n Light vs food",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)
plot(plot_L_kCO2_survival_both[nrow(plot_L_kCO2_survival_both):1,],
      xlab="Light", ylab="kCO2", main="Host survival (both symbs)\n Light vs kCO2",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)

plot(plot_N_X_survival_both[nrow(plot_N_X_survival_both):1,],
      xlab="Nitrogen", ylab="Food", main="Host survival (both symbs)\n Nitrogen vs food",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)
plot(plot_N_kCO2_survival_both[nrow(plot_N_kCO2_survival_both):1,],
      xlab="Nitrogen", ylab="kCO2", main="Host survival (both symbs)\n Nitrogen vs kCO2",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)
plot(plot_X_kCO2_survival_both[nrow(plot_X_kCO2_survival_both):1,],
      xlab="Food", ylab="kCO2", main="Host survival (both symbs)\n Food vs kCO2",
      breaks=seq(0, 1, length.out=11), col=viridis(10), key=NULL)

# Legend
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1, main="Percent of simulations\nwhere host survives")
legend("top", legend=paste0(paste(round(seq(0, 10/11*100, length.out=10),0), round(seq(1/11*100, 100, length.out=10),0), sep=" to "), "%"),
       fill=viridis(10), cex=1, ncol=2)

```

# Do hosts ever survive with one symbiont but not the other?
#### Sensitive but not tolerant (% of simulations)

```{r}
print(paste0(round(sum(healthy_sims$survival_sen & !(healthy_sims$survival_tol))/nrow(healthy_sims) * 100, 2), "%"))
```

#### Tolerant but not sensitive (% of simulations)

```{r}
print(paste0(round(sum(!(healthy_sims$survival_sen) & (healthy_sims$survival_tol))/nrow(healthy_sims) * 100, 2), "%"))
```

#### Both together, but not singly (% of simulations)

```{r}
print(paste0(round(sum(healthy_sims$survival_both & (!(healthy_sims$survival_tol) & !(healthy_sims$survival_sen)))/nrow(healthy_sims) * 100, 2), "%"))
```

#### Either (or both) singly, but not together (% of simulations)

```{r}
print(paste0(round(sum(!(healthy_sims$survival_both) & (healthy_sims$survival_tol | healthy_sims$survival_sen))/nrow(healthy_sims) * 100, 2), "%"))
```

#### Both singly, but not together (% of simulations)

```{r}
print(paste0(round(sum(!(healthy_sims$survival_both) & (healthy_sims$survival_tol & healthy_sims$survival_sen))/nrow(healthy_sims) * 100, 2), "%"))
```


# Can we predict which _environmental_ factors lead to each dominance outcome?
## Linear discriminant analysis adventures!
Start with this because it's simple, see if can get any understandable results

First we need to make the outcome a categorical variable

```{r}

dominant_symb <- rep(NA, times=nrow(healthy_sims))

for (i in 1:nrow(healthy_sims)) {
      survival_both <- healthy_sims[i, "survival_both"]
      tol_per_sen <- healthy_sims[i, "tol_per_sen"]

      if (survival_both) {
            if (tol_per_sen > 1) {
                  dominant_symb[[i]] <- "Tolerant"
            }

            if (tol_per_sen < 1) {
                  dominant_symb[[i]] <- "Sensitive"
            }

            if (tol_per_sen == 1) {
                  dominant_symb[[i]] <- "Co-dominant"
            }
      } else {
            dominant_symb[[i]] <- "No_survival"
      }
}

healthy_sims$dominant_symb <- as.factor(dominant_symb)

```

```{r}

lda_sims <- healthy_sims[(healthy_sims$L > 0) & (healthy_sims$N > 0), ]

mylda <- lda(dominant_symb ~ L + N + X + kCO2, lda_sims, tol=1e-8)

```

```{r}

plot(mylda, dimen=1)
#pairs(mylda, type="trellis")

mylda
```


## Plot decision boundaries from linear discriminant analysis

```{r}

lightPts <- seq(min(lda_sims$L), max(lda_sims$L), length.out=300)
nitrogenPts <- seq(min(lda_sims$N), max(lda_sims$N), length.out=300)
#foodPts <- seq(min(lda_sims$X), max(lda_sims$X), length.out=300)

par(mfrow=c(4, 3), mar=c(5.1, 4.1, 4.1, 6.1))
palette(c("black", "#648FFF", "#FFB000", "green"))

for (x in unique(lda_sims$X)) {
      combinedPts <- expand.grid(L=lightPts, N=nitrogenPts, X=x, kCO2=10)
      pred_factor <- predict(mylda, newdata =combinedPts)$class
      pred <- as.numeric(pred_factor)

      #print(levels(pred_factor))
      #plot(combinedPts$L, combinedPts$N, col=pred)

      plot(lda_sims[lda_sims$X==x, "L"], lda_sims[lda_sims$X==x, "N"], col = lda_sims[lda_sims$X==x, "dominant_symb"],
            xlab="Light", ylab="Nitrogen", main=paste0("Food = ", x, ", kCO2=10"))
      #points(mylda$means[, "L"], mylda$means[, "N"], pch = "+", cex = 3, col = c("#648FFF", "#FFB000", "black"))

      contour(x = lightPts, y = nitrogenPts, z = matrix(pred, nrow = 300, ncol = 300),
        levels = c(1, 2, 3), add = TRUE, drawlabels = FALSE)
}

plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1, main="'Healthy' host dominated by...")
legend("top", c("Sensitive symb.", "Tolerant symb.", "Host cannot survive"), col=c("#648FFF", "#FFB000", "black"), pch=1)

#plot(combinedPts$L, combinedPts$N, col=pred)

```

```{r}

# lightPts <- seq(min(lda_sims$L), max(lda_sims$L), length.out=300)
# #nitrogenPts <- seq(min(lda_sims$N), max(lda_sims$N), length.out=300)
# foodPts <- seq(min(lda_sims$X), max(lda_sims$X), length.out=300)
#
# par(mfrow=c(4, 3), mar=c(5.1, 4.1, 4.1, 6.1))
# palette(c("black", "#648FFF", "#FFB000", "green"))
#
# for (N in unique(lda_sims$N)) {
#       combinedPts <- expand.grid(L=lightPts, N=N, X=foodPts)
#       pred_factor <- predict(mylda, newdata =combinedPts)$class
#       pred <- as.numeric(pred_factor)
#
#       #print(levels(pred_factor))
#       #plot(combinedPts$L, combinedPts$N, col=pred)
#
#       plot(lda_sims[lda_sims$N==N, "L"], lda_sims[lda_sims$N==N, "X"], col = lda_sims[lda_sims$N==N, "dominant_symb"],
#             xlab="Light", ylab="Food", main=paste0("Nitrogen = ", N))
#       #points(mylda$means[, "L"], mylda$means[, "N"], pch = "+", cex = 3, col = c("#648FFF", "#FFB000", "black"))
#
#       contour(x = lightPts, y = foodPts, z = matrix(pred, nrow = 300, ncol = 300),
#         levels = c(1, 2, 3), add = TRUE, drawlabels = FALSE)
# }
#
# plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1, main="'Healthy' host dominated by...")
# legend("top", c("Sensitive symb.", "Tolerant symb.", "Host cannot survive"), col=c("#648FFF", "#FFB000", "black"), pch=1)
#
# #plot(combinedPts$L, combinedPts$N, col=pred)

lightPts <- seq(min(lda_sims$L), max(lda_sims$L), length.out=300)
nitrogenPts <- seq(min(lda_sims$N), max(lda_sims$N), length.out=300)
#foodPts <- seq(min(lda_sims$X), max(lda_sims$X), length.out=300)

par(mfrow=c(4, 3), mar=c(5.1, 4.1, 4.1, 6.1))
palette(c("black", "#648FFF", "#FFB000", "green"))

for (x in unique(lda_sims$X)) {
      combinedPts <- expand.grid(L=lightPts, N=nitrogenPts, X=x, kCO2=40)
      pred_factor <- predict(mylda, newdata =combinedPts)$class
      pred <- as.numeric(pred_factor)

      #print(levels(pred_factor))
      #plot(combinedPts$L, combinedPts$N, col=pred)

      plot(lda_sims[lda_sims$X==x, "L"], lda_sims[lda_sims$X==x, "N"], col = lda_sims[lda_sims$X==x, "dominant_symb"],
            xlab="Light", ylab="Nitrogen", main=paste0("Food = ", x, ", kCO2 = 40"))
      #points(mylda$means[, "L"], mylda$means[, "N"], pch = "+", cex = 3, col = c("#648FFF", "#FFB000", "black"))

      contour(x = lightPts, y = nitrogenPts, z = matrix(pred, nrow = 300, ncol = 300),
        levels = c(1, 2, 3), add = TRUE, drawlabels = FALSE)
}

plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1, main="'Healthy' host dominated by...")
legend("top", c("Sensitive symb.", "Tolerant symb.", "Host cannot survive"), col=c("#648FFF", "#FFB000", "black"), pch=1)

#plot(combinedPts$L, combinedPts$N, col=pred)

```


# Trying DAPC

```{r, cache=TRUE}
dapc_sims <- healthy_sims[(healthy_sims$L > 0) & (healthy_sims$N > 0) & (healthy_sims$X > 0), ]

mydapc <- dapc(dapc_sims[, c("L", "N", "X", "kCO2")], grp=dapc_sims$dominant_symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)
scatter(mydapc, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE, inset.pca=TRUE, col=c("#000000", "#648FFF", "#FFB000"), pch=c(0, 1, 19))
arrows(x0=0, y0=0, x1=mydapc$var.load[1,1], y1=mydapc$var.load[1,2])
text(x=mydapc$var.load[1,1]/2, y=mydapc$var.load[1,2]/2, labels="Light", pos=3)
arrows(x0=0, y0=0, x1=mydapc$var.load[2,1], y1=mydapc$var.load[2,2])
text(x=mydapc$var.load[2,1]/1, y=mydapc$var.load[2,2]/2, labels="Nitrogen", pos=4)
arrows(x0=0, y0=0, x1=mydapc$var.load[3,1], y1=mydapc$var.load[3,2])
text(x=mydapc$var.load[3,1]/2, y=mydapc$var.load[3,2]/2, labels="Food", pos=4)
arrows(x0=0, y0=0, x1=mydapc$var.load[4,1], y1=mydapc$var.load[4,2])
text(x=mydapc$var.load[4,1]/2, y=mydapc$var.load[4,2]/2, labels="KCO2", pos=4)
summary(mydapc)
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
nrow(mydapc$tab)
nrow(dapc_sims)
mydapc
```


## DAPC with sensitive-dominant cases thinned

```{r, cache=TRUE}

 dapc_sens <- dapc_sims[dapc_sims$dominant_symb=="Sensitive",]
#
 dapc_thinned <- dapc_sims[(dapc_sims$dominant_symb == "No_survival") |  (dapc_sims$dominant_symb == "Tolerant"),]

 dapc_thinned <- rbind(dapc_thinned, dapc_sens[sample(1:nrow(dapc_sens), 2000),])

 mydapc_thinned <- dapc(dapc_thinned[, c("L", "N", "X", "kCO2")], grp=dapc_thinned$dominant_symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)

```

```{r}
scatter(mydapc_thinned, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE,
      col=c("#000000", "#648FFF", "#FFB000"), pch=c(0, 2, 16))
arrows(x0=0, y0=0, x1=mydapc_thinned$var.load[1,1], y1=mydapc_thinned$var.load[1,2])
text(x=mydapc_thinned$var.load[1,1], y=mydapc_thinned$var.load[1,2], labels="Light", pos=1)
arrows(x0=0, y0=0, x1=mydapc_thinned$var.load[2,1], y1=mydapc_thinned$var.load[2,2])
text(x=mydapc_thinned$var.load[2,1], y=mydapc_thinned$var.load[2,2], labels="Nitrogen", pos=1)
arrows(x0=0, y0=0, x1=mydapc_thinned$var.load[3,1], y1=mydapc_thinned$var.load[3,2])
text(x=mydapc_thinned$var.load[3,1], y=mydapc_thinned$var.load[3,2], labels="Food", pos=2)
arrows(x0=0, y0=0, x1=mydapc_thinned$var.load[4,1], y1=mydapc_thinned$var.load[4,2])
text(x=mydapc_thinned$var.load[4,1], y=mydapc_thinned$var.load[4,2], labels="KCO2", pos=3)
summary(mydapc_thinned)
```


## DAPC with sensitive-dominant cases thinned, environmental parameters and host carbon-concentrating ability randomly drawn

```{r}

dominant_symb <- rep(NA, times=nrow(rand_healthy_sims))

for (i in 1:nrow(rand_healthy_sims)) {
      survival_both <- rand_healthy_sims[i, "survival_both"]
      tol_per_sen <- rand_healthy_sims[i, "tol_per_sen"]

      if (survival_both) {
            if (tol_per_sen > 1) {
                  dominant_symb[[i]] <- "Tolerant"
            }

            if (tol_per_sen < 1) {
                  dominant_symb[[i]] <- "Sensitive"
            }

            if (tol_per_sen == 1) {
                  dominant_symb[[i]] <- "Co-dominant"
            }
      } else {
            dominant_symb[[i]] <- "No_survival"
      }
}

rand_healthy_sims$dominant_symb <- as.factor(dominant_symb)

```

```{r, cache=TRUE}

rand_dapc_sims <- rand_healthy_sims[(rand_healthy_sims$L > 0) & (rand_healthy_sims$N > 0) & (rand_healthy_sims$X > 0), ]

 rand_dapc_sens <- rand_dapc_sims[rand_dapc_sims$dominant_symb=="Sensitive",]
#
 rand_dapc_thinned <- rand_dapc_sims[(rand_dapc_sims$dominant_symb == "No_survival") |  (rand_dapc_sims$dominant_symb == "Tolerant"),]

rand_dapc_thinned <- rbind(rand_dapc_thinned, rand_dapc_sens[sample(1:nrow(rand_dapc_sens), 2000),])
rand_mydapc_thinned <- dapc(rand_dapc_thinned[, c("L", "N", "X", "kCO2")], grp=rand_dapc_thinned$dominant_symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)
```

```{r}
scatter(rand_mydapc_thinned, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE,
      col=c("#000000", "#648FFF", "#FFB000"), pch=c(0, 2, 16))
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[1,1], y1=rand_mydapc_thinned$var.load[1,2])
text(x=rand_mydapc_thinned$var.load[1,1], y=rand_mydapc_thinned$var.load[1,2], labels="Light", pos=1)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[2,1], y1=rand_mydapc_thinned$var.load[2,2])
text(x=rand_mydapc_thinned$var.load[2,1], y=rand_mydapc_thinned$var.load[2,2], labels="Nitrogen", pos=1)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[3,1], y1=rand_mydapc_thinned$var.load[3,2])
text(x=rand_mydapc_thinned$var.load[3,1], y=rand_mydapc_thinned$var.load[3,2], labels="Food", pos=2)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[4,1], y1=rand_mydapc_thinned$var.load[4,2])
text(x=rand_mydapc_thinned$var.load[4,1], y=rand_mydapc_thinned$var.load[4,2], labels="KCO2", pos=3)
summary(rand_mydapc_thinned)
```


```{r}
pdf("healthy_host.pdf")
scatter(rand_mydapc_thinned, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE,
      col=c("#000000", "#648FFF", "#FFB000"), pch=c(0, 2, 16))
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[1,1], y1=rand_mydapc_thinned$var.load[1,2])
text(x=rand_mydapc_thinned$var.load[1,1], y=rand_mydapc_thinned$var.load[1,2], labels="Light", pos=1)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[2,1], y1=rand_mydapc_thinned$var.load[2,2])
text(x=rand_mydapc_thinned$var.load[2,1], y=rand_mydapc_thinned$var.load[2,2], labels="Nitrogen", pos=1)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[3,1], y1=rand_mydapc_thinned$var.load[3,2])
text(x=rand_mydapc_thinned$var.load[3,1], y=rand_mydapc_thinned$var.load[3,2], labels="Food", pos=2)
arrows(x0=0, y0=0, x1=rand_mydapc_thinned$var.load[4,1], y1=rand_mydapc_thinned$var.load[4,2])
text(x=rand_mydapc_thinned$var.load[4,1], y=rand_mydapc_thinned$var.load[4,2], labels="KCO2", pos=3)
dev.off()
```

## What are those 4 tolerant points all by themselves?

```{r}

tol_grp <- mydapc_thinned$ind.coord[(mydapc_thinned$grp=="Tolerant") &
	(mydapc_thinned$ind.coord[,1] < 0),]

plot(mydapc_thinned$ind.coord[,1], mydapc_thinned$ind.coord[,2],
	col=c(NA, NA, "orange")[mydapc_thinned$grp],
	main="Host dominated by tolerant symb.",
	xlab = "LDA axis 1", ylab="LDA axis 2")

points(tol_grp[,1], tol_grp[,2], col="red", pch=16)

print(dapc_thinned[rownames(tol_grp), c("L", "N", "X", "kCO2")])

```


## "Thicken" the area around the 4 tolerant points (investigate more points there)

```{r, cache=TRUE}

# Code for run_coral, so we can make sure the updated version was used
body(coRal::run_coral)

# run simulations for 600 days
time<-seq(1, 600, 0.1)

extra_search_params <- expand.grid("L"=40,       # Light = 40
                            "N"=seq(3e-6, 3.9e-6, length.out=11),     # DIN
                            "X" = seq(3.2e-7, 3.6e-7, length.out=11),     # Food
                            "kCO2" = 10)    

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

extra_results <- foreach(i=1:nrow(extra_search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(extra_search_params[i, "L"], extra_search_params[i, "L"], 0),
                           N=c(extra_search_params[i, "N"], extra_search_params[i, "N"], 0), X=c(extra_search_params[i, "X"], extra_search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- coRal::run_coral(time=time, env=env, pars=replace(pars_sen, "kCO2", extra_search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- coRal::run_coral(time=time, env=env, pars=replace(pars_tol, "kCO2", extra_search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- coRal::run_coral(time=time, env=env, pars=replace(pars_both, "kCO2", extra_search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=extra_search_params[i, "L"], "N"=extra_search_params[i, "N"], "X"=extra_search_params[i, "X"],
    "kCO2"=extra_search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
extra_healthy_sims <- data.frame(extra_results, row.names=NULL)
```

```{r}
# set the columns to their proper types
extra_healthy_sims <- transform(extra_healthy_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```

```{r}

dominant_symb <- rep(NA, times=nrow(extra_healthy_sims))

for (i in 1:nrow(extra_healthy_sims)) {
      survival_both <- extra_healthy_sims[i, "survival_both"]
      tol_per_sen <- extra_healthy_sims[i, "tol_per_sen"]

      if (survival_both) {
            if (tol_per_sen > 1) {
                  dominant_symb[[i]] <- "Tolerant"
            }

            if (tol_per_sen < 1) {
                  dominant_symb[[i]] <- "Sensitive"
            }

            if (tol_per_sen == 1) {
                  dominant_symb[[i]] <- "Co-dominant"
            }
      } else {
            dominant_symb[[i]] <- "No_survival"
      }
}

extra_healthy_sims$dominant_symb <- as.factor(dominant_symb)

```


```{r}

plot(extra_healthy_sims$N, extra_healthy_sims$X, col=c("orange", "blue")[extra_healthy_sims$dominant_symb], pch=as.character(extra_healthy_sims$dominant_symb))
summary(extra_healthy_sims)
```
