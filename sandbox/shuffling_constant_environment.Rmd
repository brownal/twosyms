---
title: "Symbiont shuffling in a constant environment"
author: "Ross Cunning and Alexandra Brown"
date: "3/11/2020"
output: html_document
---
```{r}
```{r}
# Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = TRUE,fig.width=30, fig.height=30) 


# Load packages
library(coRal)
library(plotrix)
library(scales)
require(foreach)
require(parallel)
require(doParallel)
library(tidyverse)
library(plot.matrix)

# Make plots larger
#options(repr.plot.res=400)
```
```
```{r}
# Find the mean of value over a certain year/cycle of environmental change
# Takes as input:
# - value, a list of values the variable of interest takes over time
# - time, a list of time points the variable was recorded at
# - envPeriod, the period of the cycle of environmental change (e.g. 365 for a year)
# - cycleNumber, the year or (cycleNumber)th cycle of environmental change over which to average value
meanOverCycle <- function(value, time, envPeriod, cycleNumber) {
    focalCycle <- ((time > envPeriod*(cycleNumber - 1)) & (time <= envPeriod * cycleNumber))
    meanValue <- mean(value[focalCycle])
    return(meanValue)
}
```

```{r}
cols=c("blue", "red")

plot_2sh <- function(run) with(run, {
  plot(time, env.L, type="l", col=scales::alpha("gold", 0.5), axes=F, ylim=c(0, 50), ylab="", xlab="")
  axis(side=4)
  par(new=T)
  plot(time, (S.1+S.2)/H, ylim=c(0, max((S.1+S.2)/H*1.1)), type="l", ylab="S/H", xlab="Days")
  lines(S.1/H ~ time, col="blue")
  lines(S.2/H ~ time, col="red")
  legend("topright", legend=c("sensitive", "tolerant"), col=c("blue", "red"), lty=1, bty="n")
})
```

## Investigate where shuffling (or reversion to a sensitive symbiont occurs)


Will look over:
* a range of light, nutrient, and prey values (following values used in Cunning et al. 2017)
* both high and low initial sensitive:tolerant symbiont ratios (to check for conditions that allow switching to the tolerant symbiont or reversion to the sensitive symbiont)
* both high and low initial total symbiont:host ratios (to check for hysteresis)

```{r}
time <- seq(1, 5*365,0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
df <- expand.grid("L"=seq(5, 50, 5), "N"=seq(0, 4e-6, 5e-7),"X"=c(0, 1e-7, 1e-6), "initSH" = c(0.1, 0.0001), "initST" = c(1000, 0.001))

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)
  
# Run simulations in parallel for each combination of "at" values
start <- proc.time()  # Start timer...

# Calculate steady states...
steady_states <- foreach(i=1:nrow(df), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(df[i, "L"], df[i, "L"], 0), N=c(df[i, "N"], df[i, "N"], 0), X=c(df[i, "X"], df[i, "X"], 0))
    tempPars <- pars
    tempPars$initS[1] <- df[i, "initSH"] * df[i, "initST"]/(df[i, "initST"] + 1)
    tempPars$initS[2] <- df[i, "initSH"] * 1/(df[i, "initST"] + 1)
    run <- coRal::run_coral(time=time, env=env, pars=tempPars)
    
    gr <- last(run$dH.Hdt)
    host <- last(run$H)
    ssymb <- last(run$S.1)
    tsymb <- last(run$S.2)
    totSymb <- ssymb + tsymb
    shratio <- totSymb / host
    stratio <- ssymb / tsymb
    
   list(L=df[i, "L"], N=df[i, "N"], X=df[i, "X"], initSH=df[i, "initSH"], initST=df[i, "initST"],
        gr=gr, host=host, ssymb=ssymb, tsymb=tsymb, totSymb=totSymb, shratio=shratio, stratio=stratio)
}
stopCluster(cl)  # Stop cluster
print(proc.time() - start)  # Print time elapsed
dfSteadyStates <- data.frame(steady_states, row.names=NULL)
```

## Plot the host growth rate

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

## Plot the total symbiont: host ratio

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

## Plot log base 10 of (sensitive: tolerant symbiont ratio)

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(log(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(log(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(log(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(log(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

# Check what things look like after another 5 years to make sure things have converged

```{r}
time <- seq(1,10*365,0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
df <- expand.grid("L"=seq(5, 50, 5), "N"=seq(0, 4e-6, 5e-7),"X"=c(0, 1e-7, 1e-6), "initSH" = c(0.1, 0.0001), "initST" = c(1000, 0.001))

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)
  
# Run simulations in parallel for each combination of "at" values
start <- proc.time()  # Start timer...

# Calculate steady states...
steady_states_10years <- foreach(i=1:nrow(df), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(df[i, "L"], df[i, "L"], 0), N=c(df[i, "N"], df[i, "N"], 0), X=c(df[i, "X"], df[i, "X"], 0))
    tempPars <- pars
    tempPars$initS[1] <- df[i, "initSH"] * df[i, "initST"]/(df[i, "initST"] + 1)
    tempPars$initS[2] <- df[i, "initSH"] * 1/(df[i, "initST"] + 1)
    run <- coRal::run_coral(time=time, env=env, pars=tempPars)
    
    gr <- last(run$dH.Hdt)
    host <- last(run$H)
    ssymb <- last(run$S.1)
    tsymb <- last(run$S.2)
    totSymb <- ssymb + tsymb
    shratio <- totSymb / host
    stratio <- ssymb / tsymb
    
   list(L=df[i, "L"], N=df[i, "N"], X=df[i, "X"], initSH=df[i, "initSH"], initST=df[i, "initST"],
        gr=gr, host=host, ssymb=ssymb, tsymb=tsymb, totSymb=totSymb, shratio=shratio, stratio=stratio)
}
stopCluster(cl)  # Stop cluster
print(proc.time() - start)  # Print time elapsed
dfSteadyStates <- data.frame(steady_states_10years, row.names=NULL)
```

## Plot the host growth rate

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

## Plot the total symbiont: host ratio

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

## Plot log base 10 of (sensitive: tolerant symbiont ratio)

```{r}
par(mfcol=c(4, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 4 initial conditions high/low initial S:H x high/low initial S:T
    #low S:H, low ST
    lowSHlowSTinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H, low ST
    highSHlowSTinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 0.001) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #low S:H, high ST
    lowSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    #high S:H, high ST
    highSHhighSTinit =
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$initST == 1000) & (dfSteadyStates$X == X), "stratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(log(lowSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, low ST"))
    
    plot(log(highSHlowSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH, low ST"))
    
    plot(log(lowSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH, high ST"))
    
    plot(log(highSHhighSTinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], 10), breaks=c(-500, -10, -5, -2, -1, 0, 1, 2, 5, 10, 500),
        xlab="N", ylab="L",main=paste("X =", X, "\ninit high SH, high ST"))
}
```

# Why don't things match the 1-symbiont case? Try setting the tolerant symbiont to 0 & see what happens

```{r}
time <- seq(1, 5*365,0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
df <- expand.grid("L"=seq(5, 50, 5), "N"=seq(0, 4e-6, 5e-7),"X"=c(0, 1e-7, 1e-6), "initSH" = c(0.1, 0.0001))

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)
  
# Run simulations in parallel for each combination of "at" values
start <- proc.time()  # Start timer...

# Calculate steady states...
steady_states_1symb <- foreach(i=1:nrow(df), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(df[i, "L"], df[i, "L"], 0), N=c(df[i, "N"], df[i, "N"], 0), X=c(df[i, "X"], df[i, "X"], 0))
    tempPars <- pars
    tempPars$initS[1] <- df[i, "initSH"]
    tempPars$initS[2] <- 0
    run <- coRal::run_coral(time=time, env=env, pars=tempPars)
    
    gr <- last(run$dH.Hdt)
    host <- last(run$H)
    ssymb <- last(run$S.1)
    tsymb <- last(run$S.2)
    totSymb <- ssymb + tsymb
    shratio <- totSymb / host
    stratio <- ssymb / tsymb
    
   list(L=df[i, "L"], N=df[i, "N"], X=df[i, "X"], initSH=df[i, "initSH"],
        gr=gr, host=host, ssymb=ssymb, tsymb=tsymb, totSymb=totSymb, shratio=shratio, stratio=stratio)
}
stopCluster(cl)  # Stop cluster
print(proc.time() - start)  # Print time elapsed
dfSteadyStates <- data.frame(steady_states_1symb, row.names=NULL)
```

## Plot the host growth rate

```{r}
par(mfcol=c(2, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 2 initial conditions: high/low initial S:H
    #low S:H
    lowSHinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H
    highSHinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH"))
    
    plot(highSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH"))
}
```

## Plot the total symbiont: host ratio

```{r}
par(mfcol=c(2, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 2 initial conditions: high/low initial S:H
    #low S:H
    lowSHinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H
    highSHinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH"))
    
    plot(highSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH"))
}
```

# Let's try just running for 1 year to see if it's a numerical issue

```{r}
time <- seq(1,365,0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
df <- expand.grid("L"=seq(5, 50, 5), "N"=seq(0, 4e-6, 5e-7),"X"=c(0, 1e-7, 1e-6), "initSH" = c(0.1, 0.0001))

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)
  
# Run simulations in parallel for each combination of "at" values
start <- proc.time()  # Start timer...

# Calculate steady states...
steady_states_1symb_1year <- foreach(i=1:nrow(df), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(df[i, "L"], df[i, "L"], 0), N=c(df[i, "N"], df[i, "N"], 0), X=c(df[i, "X"], df[i, "X"], 0))
    tempPars <- pars
    tempPars$initS[1] <- df[i, "initSH"]
    tempPars$initS[2] <- 0
    run <- coRal::run_coral(time=time, env=env, pars=tempPars)
    
    gr <- last(run$dH.Hdt)
    host <- last(run$H)
    ssymb <- last(run$S.1)
    tsymb <- last(run$S.2)
    totSymb <- ssymb + tsymb
    shratio <- totSymb / host
    stratio <- ssymb / tsymb
    
   list(L=df[i, "L"], N=df[i, "N"], X=df[i, "X"], initSH=df[i, "initSH"],
        gr=gr, host=host, ssymb=ssymb, tsymb=tsymb, totSymb=totSymb, shratio=shratio, stratio=stratio)
}
stopCluster(cl)  # Stop cluster
print(proc.time() - start)  # Print time elapsed
dfSteadyStates <- data.frame(steady_states_1symb_1year, row.names=NULL)
```

## Plot the host growth rate

```{r}
par(mfcol=c(2, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 2 initial conditions: high/low initial S:H
    #low S:H
    lowSHinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H
    highSHinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$X == X), "gr"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH"))
    
    plot(highSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(-0.04, -0.02, 0, 0.02, 0.04, 0.06, 0.08, 0.1, 0.12, 0.14),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH"))
}
```

## Plot the total symbiont: host ratio

```{r}
par(mfcol=c(2, 3))
for (X in c(0, 1e-7, 1e-6)) {
    # Get the matrices for the plots: 2 initial conditions: high/low initial S:H
    #low S:H
    lowSHinit = 
    matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.0001) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
  
    #high S:H
    highSHinit =
        matrix(as.numeric(dfSteadyStates[(dfSteadyStates$initSH == 0.1) & (dfSteadyStates$X == X), "shratio"]), nrow=10,
           dimnames=list(list(5, 10, 15, 20, 25, 30, 35, 40, 45, 50), list(0, 5e-7, 1e-6, 1.5e-6, 2e-6, 2.5e-6, 3e-6, 3.5e-6, 4e-6)))
    
    # Make the plots
    plot(lowSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit low SH"))
    
    plot(highSHinit[c(10, 9, 8, 7, 6, 5, 4, 3, 2, 1),], breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1, 2, 3, 4, 5),
        xlab="N", ylab="L", main=paste("X =", X, "\ninit high SH"))
}
```

```{r}

```
