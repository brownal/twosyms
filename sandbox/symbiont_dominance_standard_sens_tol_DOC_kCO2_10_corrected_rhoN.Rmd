---
title: "Healthy and bleached hosts with sensitive and tolerant symbionts (DOC and no DOC, corrected rhoN)"
author: "Ross Cunning and Alexandra Brown"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
      html_document:
            code_folding: hide
---

```{r}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, fig.width=8, fig.height=8, results='hold')

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")
library("MASS")
library("plot3D")
library("adegenet")
library("knitr")

source("run_coral_rhoN.R")
source("run_coral_oc_rhoN.R")
source("synth.R")

options(repr.plot.res=240)
```

# Simulate healthy corals with sensitive and tolerant symbionts alone and together

The goal is to find out

1. When both symbionts are present, which one dominates the host?
2. How does the presence of dissolved organic carbon affect this?


### Set symbiont parameters

```{r}
# parameters for single-symbiont simulations
# sensitive symb. parameters
pars_sen <- def_pars(nsym=1)
pars_sen$initS <- 1

# tolerant symb. parameters
pars_tol <- def_pars(nsym=1)
pars_tol$jCPm <- 1.0
pars_tol$kROS <- 250
pars_tol$jSGm <- 0.15
pars_tol$initS <- 1

# parameters for two-symbiont simulations
# sensitive symbiont is symbiont 1; tolerant is symbiont 2
pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5, 0.5)
```


### No DOC simulations

#### Actually run the simulations

```{r no-doc-sims, cache=TRUE}

# run simulations for 600 days
time<-seq(0, 600, 0.1)

search_params <- data.frame("L"=runif(30000, 5, 60),       # Light, choose values between 5 and 40
                            "N"=runif(30000, 1e-8, 1e-5),     # DIN, choose values between 0 and 6e-6
                            "X" = runif(30000, 0, 4e-7),     # Food, choose values between 0 and 4e07
                            "kCO2" = rep(10, 30000))   # Host carbon-concentrating ability, choose value of 10

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- run_coral_rhoN(time=time, env=env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- run_coral_rhoN(time=time, env=env, pars=replace(pars_tol, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- run_coral_rhoN(time=time, env=env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"], "X"=search_params[i, "X"],
    "kCO2"=search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
no_doc_sims <- data.frame(results, row.names=NULL)
```

#### Set the columns of the summary dataframe to their proper types (numerical/factor)

```{r no-doc-column-types}
# set the columns to their proper types
no_doc_sims <- transform(no_doc_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```


#### Find the dominant symbiont when both symbionts are present

```{r no-doc-dominant-symb}

dominant_symb <- rep(NA, times=nrow(no_doc_sims))

for (i in 1:nrow(no_doc_sims)) {
      survival_both <- no_doc_sims[i, "survival_both"]
      tol_per_sen <- no_doc_sims[i, "tol_per_sen"]

      if (survival_both) {
            if (tol_per_sen > 1) {
                  dominant_symb[[i]] <- "Tolerant"
            }

            if (tol_per_sen < 1) {
                  dominant_symb[[i]] <- "Sensitive"
            }

            if (tol_per_sen == 1) {
                  dominant_symb[[i]] <- "Co-dominant"
            }
      } else {
            dominant_symb[[i]] <- "No_survival"
      }
}


no_doc_sims$dominant_symb <- factor(dominant_symb, levels=c("Sensitive", "No_survival", "Tolerant", "Co-dominant"))
```


#### Find where hosts are able to survive with only one symbiont

```{r no-doc-1-symb-survival}

survival_1symb <- rep(NA, times=nrow(no_doc_sims))

for (i in 1:nrow(no_doc_sims)) {
  survival_sen <- no_doc_sims[i, "survival_sen"]
  survival_tol <- no_doc_sims[i, "survival_tol"]

  if (survival_sen && survival_tol) {
    survival_1symb[[i]] <- "Both"
  } else {
    if (survival_sen) {
      survival_1symb[[i]] <- "Sensitive"
    } else if (survival_tol) {
      survival_1symb[[i]] <- "Tolerant"
    } else {
      survival_1symb[[i]] <- "No_survival"
    }
  }
}

no_doc_sims$survival_1symb <- factor(survival_1symb, levels=c("Sensitive", "No_survival", "Tolerant", "Both"))
```

### Run some extra simulations where no food is present (will help with understanding the results)

```{r no-doc-no-food-sims, cache=TRUE}

time<-seq(0, 600, 0.1)

search_params <- expand.grid("L"=seq(5, 60, 0.5),       # Light, choose values between 5 and 40
                            "N"=seq(1e-8, 1e-5, 1e-7),     # DIN, choose values between 0 and 6e-6
                            "X" = 0,     # Food, choose values between 0 and 4e07
                            "kCO2" = 10)   # Host carbon-concentrating ability, choose value of 10

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- run_coral_rhoN(time=time, env=env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- run_coral_rhoN(time=time, env=env, pars=replace(pars_tol, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- run_coral_rhoN(time=time, env=env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"], "X"=search_params[i, "X"],
    "kCO2"=search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
no_doc_no_food_sims <- data.frame(results, row.names=NULL)


```

#### Set the proper column types

```{r no-doc-no-food-column-types}
# set the columns to their proper types
no_doc_no_food_sims <- transform(no_doc_no_food_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```

#### Find where hosts are able to survive with only one symbiont

```{r no-doc-no-food-1-symb-survival}

survival_1symb <- rep(NA, times=nrow(no_doc_no_food_sims))

for (i in 1:nrow(no_doc_no_food_sims)) {
  survival_sen <- no_doc_no_food_sims[i, "survival_sen"]
  survival_tol <- no_doc_no_food_sims[i, "survival_tol"]

  if (survival_sen && survival_tol) {
    survival_1symb[[i]] <- "Both"
  } else {
    if (survival_sen) {
      survival_1symb[[i]] <- "Sensitive"
    } else if (survival_tol) {
      survival_1symb[[i]] <- "Tolerant"
    } else {
      survival_1symb[[i]] <- "No_survival"
    }
  }
}

no_doc_no_food_sims$survival_1symb <- factor(survival_1symb, levels=c("Sensitive", "No_survival", "Tolerant", "Both"))
```



### DOC simulations

#### Actually run the simulations

```{r doc-sims, cache=TRUE}

# run simulations for 600 days
time<-seq(0, 600, 0.1)

search_params <- data.frame("L"=runif(30000, 5, 60),       # Light, choose values between 5 and 40
                            "N"=runif(30000, 1e-8, 1e-5),     # DIN, choose values between 0 and 6e-6
                            "X" = runif(30000, 0, 4e-7),     # Food, choose values between 0 and 4e07
                            "kCO2" = rep(10, 30000))   # Host carbon-concentrating ability, choose value of 10

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))


    # Simulations!
    # simulate dynamics with just the sensitive symbiont
    run_sen <- run_coral_oc_rhoN(time=time, env=env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with just the tolerant symbiont
    run_tol <- run_coral_oc_rhoN(time=time, env=env, pars=replace(pars_tol, "kCO2", search_params[i, "kCO2"]))

    # simulate dynamics with both symbionts
    run_both <- run_coral_oc_rhoN(time=time, env=env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


    # Process simulations to get summary statistics

    # 1. Convergence: have the host and symbiont growth rates stabilized? (Changed by no more than 10^-6 between the last and penultimate time steps)
    # 1a. Simulation with sensitive symbiont alone
    converge_sen_H <- (abs(run_sen$dH.Hdt[length(time)] - run_sen$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_sen_S <- (abs(run_sen$dS.Sdt[length(time)] - run_sen$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_sen <- converge_sen_H & converge_sen_S

    # 1b. Simulation with tolerant symbiont alone
    converge_tol_H <- (abs(run_tol$dH.Hdt[length(time)] - run_tol$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_tol_S <- (abs(run_tol$dS.Sdt[length(time)] - run_tol$dS.Sdt[length(time)-1]) <= 1e-6)
    converge_tol <- converge_tol_H & converge_tol_S

    # 1c. Simulation with both symbionts
    converge_both_H <- (abs(run_both$dH.Hdt[length(time)] - run_both$dH.Hdt[length(time)-1]) <= 1e-6)
    converge_both_S1 <- (abs(run_both$dS.Sdt.1[length(time)] - run_both$dS.Sdt.1[length(time)-1]) <= 1e-6)
    converge_both_S2 <- (abs(run_both$dS.Sdt.2[length(time)] - run_both$dS.Sdt.2[length(time)-1]) <= 1e-6)
    converge_both <- converge_both_H & (converge_both_S1 & converge_both_S2)

    # 2. Survival: does the coral have positive growth at the end of the simulation?
    survival_sen <- run_sen$dH.Hdt[length(time)] > 0
    survival_tol <- run_tol$dH.Hdt[length(time)] > 0
    survival_both <- run_both$dH.Hdt[length(time)] > 0

    # 3. Dominance: when both symbionts are present, what is the sensitive:tolerant symbiont ratio?
    tol_per_sen = run_both$S.2[length(time)]/run_both$S.1[length(time)]

    # 4. Symbiont: host ratio
    sh_ratio_sen = run_sen$S[length(time)]/run_sen$H[length(time)]
    sh_ratio_tol = run_tol$S[length(time)]/run_tol$H[length(time)]
    sh_ratio_both = (run_both$S.1[length(time)] + run_both$S.2[length(time)])/run_both$H[length(time)]

    # 5. Host growth rate
    host_growth_sen = run_sen$dH.Hdt[length(time)]
    host_growth_tol = run_tol$dH.Hdt[length(time)]
    host_growth_both = run_both$dH.Hdt[length(time)]

    # return the parameters and summary statistics
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"], "X"=search_params[i, "X"],
    "kCO2"=search_params[i, "kCO2"],
    "converge_sen"=converge_sen, "converge_tol"=converge_tol, "converge_both"=converge_both,
    "survival_sen"=survival_sen, "survival_tol"=survival_tol, "survival_both"=survival_both,
    "tol_per_sen"=tol_per_sen,
    "sh_ratio_sen"=sh_ratio_sen, "sh_ratio_tol"=sh_ratio_tol, "sh_ratio_both"=sh_ratio_both,
    "host_growth_sen"=host_growth_sen, "host_growth_tol"=host_growth_tol, "host_growth_both"=host_growth_both)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
doc_sims <- data.frame(results, row.names=NULL)
```

#### Set the proper column types

```{r doc-column-types}
# set the columns to their proper types
doc_sims <- transform(doc_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      converge_sen=as.logical(converge_sen), converge_tol=as.logical(converge_tol), converge_both=as.logical(converge_both),
      survival_sen=as.logical(survival_sen), survival_tol=as.logical(survival_tol), survival_both=as.logical(survival_both),
      tol_per_sen=as.numeric(tol_per_sen),
      sh_ratio_sen=as.numeric(sh_ratio_sen), sh_ratio_tol=as.numeric(sh_ratio_tol), sh_ratio_both=as.numeric(sh_ratio_both),
      host_growth_sen=as.numeric(host_growth_sen), host_growth_tol=as.numeric(host_growth_tol), host_growth_both=as.numeric(host_growth_both))
```

#### Find the dominant symbiont when both symbionts are present

```{r doc-dominant-symb}

dominant_symb <- rep(NA, times=nrow(doc_sims))

for (i in 1:nrow(doc_sims)) {
      survival_both <- doc_sims[i, "survival_both"]
      tol_per_sen <- doc_sims[i, "tol_per_sen"]

      if (survival_both) {
            if (tol_per_sen > 1) {
                  dominant_symb[[i]] <- "Tolerant"
            }

            if (tol_per_sen < 1) {
                  dominant_symb[[i]] <- "Sensitive"
            }

            if (tol_per_sen == 1) {
                  dominant_symb[[i]] <- "Co-dominant"
            }
      } else {
            dominant_symb[[i]] <- "No_survival"
      }
}

doc_sims$dominant_symb <- factor(dominant_symb, levels=c("Sensitive", "No_survival", "Tolerant", "Co-dominant"))
```

#### Find where hosts are able to survive with only one symbiont

```{r doc-1-symb-survival}

survival_1symb <- rep(NA, times=nrow(doc_sims))

for (i in 1:nrow(no_doc_sims)) {
  survival_sen <- doc_sims[i, "survival_sen"]
  survival_tol <- doc_sims[i, "survival_tol"]

  if (survival_sen && survival_tol) {
    survival_1symb[[i]] <- "Both"
  } else {
    if (survival_sen) {
      survival_1symb[[i]] <- "Sensitive"
    } else if (survival_tol) {
      survival_1symb[[i]] <- "Tolerant"
    } else {
      survival_1symb[[i]] <- "No_survival"
    }
  }
}

doc_sims$survival_1symb <- factor(survival_1symb, levels=c("Sensitive", "No_survival", "Tolerant", "Both"))
```

# Healthy host simulations: analysis and plots

We're going to try to figure out how environmental conditions influence which symbiont dominates the host and which symbiont(s) the host can survive with.

## No DOC

### DAPC analysis of the dominant symbiont when 2 symbionts are present

```{r}
dapc_sims <- no_doc_sims

mydapc <- dapc(dapc_sims[, c("L", "N", "X", "kCO2")], grp=dapc_sims$dominant_symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)
# scatter(mydapc, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE, inset.pca=TRUE, col=c("#648FFF", "#000000", "#FFB000"), pch=c(0, 1, 19))
# arrows(x0=0, y0=0, x1=mydapc$var.load[1,1], y1=mydapc$var.load[1,2])
# text(x=mydapc$var.load[1,1]/2, y=mydapc$var.load[1,2]/2, labels="Light", pos=3)
# arrows(x0=0, y0=0, x1=mydapc$var.load[2,1], y1=mydapc$var.load[2,2])
# text(x=mydapc$var.load[2,1]/1, y=mydapc$var.load[2,2]/2, labels="Nitrogen", pos=4)
# arrows(x0=0, y0=0, x1=mydapc$var.load[3,1], y1=mydapc$var.load[3,2])
# text(x=mydapc$var.load[3,1]/2, y=mydapc$var.load[3,2]/2, labels="Food", pos=4)
# arrows(x0=0, y0=0, x1=mydapc$var.load[4,1], y1=mydapc$var.load[4,2])
# text(x=mydapc$var.load[4,1]/2, y=mydapc$var.load[4,2]/2, labels="KCO2", pos=4)
mydapc
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
summary(mydapc)
```

### Plot of the dominant symbiont when 2 symbionts are present in the host

```{r}
# png("no_doc_dapc_healthy.png")
plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF", rgb(0, 0, 0), "#FFB000")[mydapc$grp], pch=c(1, 0, 19, 15)[mydapc$grp],
  xlab="DAPC axis 1", ylab="DAPC axis 2")

# rect(xleft=mydapc$grp.coord[1, "LD1"] - 1.25*strwidth("Survives w/ S")/2,
#   xright=mydapc$grp.coord[1, "LD1"] + 1.25*strwidth("Survives w/ S")/2,
#   ybottom=mydapc$grp.coord[1, "LD2"] - 1.25*strheight("Survives w/ S")/2,
#   ytop=mydapc$grp.coord[1, "LD2"] + 1.25*strheight("Survives w/ S")/2,
#   col="white", border=NA)
# text(x=mydapc$grp.coord[1, "LD1"], y=mydapc$grp.coord[1, "LD2"], labels="Survives w/ S", col="#648FFF")

arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1)
text(x=1.25*mydapc$var.load[1,1], y=1.25*mydapc$var.load[1,2], labels="Light", pos=3)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1)
text(x=1.5*mydapc$var.load[2,1], y=1.5*mydapc$var.load[2,2], labels="Nitrogen", pos=4)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1)
text(x=1.5*mydapc$var.load[3,1], y=1.5*mydapc$var.load[3,2], labels="Food", pos=4)
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[4,1], y1=1.5*mydapc$var.load[4,2], length=0.1)
# text(x=1.5*mydapc$var.load[4,1], y=1.5*mydapc$var.load[4,2], labels="Host CCM", pos=4)

legend("topright", c("Sensitive", "Tolerant", "No survival"),
col=c("#648FFF", "#FFB000", rgb(0, 0, 0)), pch=c(1, 19, 0),
bg="white")
# dev.off()
```

### Plot of the distribution of the simulated environmental variables
Colored by dominant symbiont

```{r}

par(mfrow=c(2,2))

### Light

mybreaks <- seq(5, 60, 2.5) #Otherwise it auto-includes values between 4 and 5, which we didn't simulate

hist(no_doc_sims$L, col="black", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(no_doc_sims$L[(no_doc_sims$dominant_symb=="Sensitive") |
	(no_doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$L[no_doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Nitrogen

mybreaks <- hist(no_doc_sims$N, plot=FALSE)$breaks

hist(no_doc_sims$N, col="black", breaks=mybreaks,
	xlab="Nitrogen (mol/L)", ylab="# Simulations",
	main="Nitrogen")

hist(no_doc_sims$N[(no_doc_sims$dominant_symb=="Sensitive") |
	(no_doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$N[no_doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")




### Food

mybreaks <- hist(no_doc_sims$X, plot=FALSE)$breaks

hist(no_doc_sims$X, col="black", breaks=mybreaks,
	xlab="Food (mol/L)", ylab="# Simulations",
	main="Food")

hist(no_doc_sims$X[(no_doc_sims$dominant_symb=="Sensitive") |
	(no_doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$X[no_doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Legend
plot.new()
legend("top", c("Sensitive symb.", "Tolerant symb.", "No survival"),
	col=c("#648FFF", "#FFB000", "black"), pch=15,
	title="Dominant symb.")


```

### DAPC analysis of host survival with each symbiont alone

```{r}

dapc_sims <- no_doc_sims

mydapc <- dapc(dapc_sims[, c("L", "N", "X", "kCO2")], grp=dapc_sims$survival_1symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)

mydapc
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
summary(mydapc)

```

### Plot of host survival with each symbiont alone

```{r}
# png("no_doc_dapc_healthy_1symb.png")

plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF", rgb(0, 0, 0), "#FFB000", "#00FABE")[mydapc$grp], pch=c(1, 0, 19, 3)[mydapc$grp],
  xlab="DAPC axis 1", ylab="DAPC axis 2")


arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1)
text(x=1.5*mydapc$var.load[1,1], y=1.5*mydapc$var.load[1,2], labels="Light", pos=3)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1)
text(x=1.5*mydapc$var.load[2,1], y=1.5*mydapc$var.load[2,2], labels="Nitrogen", pos=4)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1)
text(x=1.5*mydapc$var.load[3,1], y=1.5*mydapc$var.load[3,2], labels="Food", pos=4)
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[4,1], y1=1.5*mydapc$var.load[4,2], length=0.1)
# text(x=1.5*mydapc$var.load[4,1], y=1.5*mydapc$var.load[4,2], labels="Host CCM", pos=4)

legend("topright", c("Sensitive", "Tolerant", "Either", "No survival"),
col=c("#648FFF", "#FFB000", "#00FABE", rgb(0, 0, 0)), pch=c(1, 19, 3, 0),
bg="white")
# dev.off()
```

### Plot of the distribution of the simulated environmental variables
Colored by which symbiont(s) hosts can survive with

```{r}

par(mfrow=c(2,2))

### Light

mybreaks <- seq(5, 60, 2.5) #Otherwise it auto-includes values between 4 and 5, which we didn't simulate

hist(no_doc_sims$L, col="black", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(no_doc_sims$L[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant") | (no_doc_sims$survival_1symb=="Both")],
	breaks=mybreaks, add=TRUE, col="#00FABE")

hist(no_doc_sims$L[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$L[no_doc_sims$survival_1symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Nitrogen

mybreaks <- hist(no_doc_sims$N, plot=FALSE)$breaks

hist(no_doc_sims$N, col="black", breaks=mybreaks,
	xlab="Nitrogen (mol/L)", ylab="# Simulations",
	main="Nitrogen")

hist(no_doc_sims$N[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant") | (no_doc_sims$survival_1symb=="Both")],
	breaks=mybreaks, add=TRUE, col="#00FABE")

hist(no_doc_sims$N[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$N[no_doc_sims$survival_1symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")


### Food

mybreaks <- hist(no_doc_sims$X, plot=FALSE)$breaks

hist(no_doc_sims$X, col="black", breaks=mybreaks,
	xlab="Food (mol/L)", ylab="# Simulations",
	main="Food")

hist(no_doc_sims$X[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant") | (no_doc_sims$survival_1symb=="Both")],
	breaks=mybreaks, add=TRUE, col="#00FABE")

hist(no_doc_sims$X[(no_doc_sims$survival_1symb=="Sensitive") |
	(no_doc_sims$survival_1symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_sims$X[no_doc_sims$survival_1symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Legend
plot.new()
legend("top", c("Sensitive symb.", "Tolerant symb.", "Either", "No survival"),
	col=c("#648FFF", "#FFB000", "#00FABE", "black"), pch=15,
	title="Dominant symb.")


```



### Plot of host survival with each symbiont alone when there is no food present in the environment

```{r}
plot(no_doc_no_food_sims$L, no_doc_no_food_sims$N, col=c("#648FFF", rgb(0, 0, 0), "#FFB000", "#00FABE")[no_doc_no_food_sims$survival_1symb],
pch=c(1, 0, 19, 3)[no_doc_no_food_sims$survival_1symb], xlab="Light (mol photons/m^2/day)", ylab="Nitrogen (mol/L)", main="Survival without food")
```

## DOC

### DAPC analysis of the dominant symbiont when 2 symbionts are present

```{r}
dapc_sims <- doc_sims

mydapc <- dapc(dapc_sims[, c("L", "N", "X", "kCO2")], grp=dapc_sims$dominant_symb, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)

mydapc
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
summary(mydapc)
```

### Plot of the dominant symbiont when 2 symbionts are present

```{r}
#png("doc_dapc_healthy.png")
plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF", rgb(0, 0, 0), "#FFB000")[mydapc$grp], pch=c(1, 0, 19, 15)[mydapc$grp],
  xlab="DAPC axis 1", ylab="DAPC axis 2")

# rect(xleft=mydapc$grp.coord[1, "LD1"] - 1.25*strwidth("Survives w/ S")/2,
#   xright=mydapc$grp.coord[1, "LD1"] + 1.25*strwidth("Survives w/ S")/2,
#   ybottom=mydapc$grp.coord[1, "LD2"] - 1.25*strheight("Survives w/ S")/2,
#   ytop=mydapc$grp.coord[1, "LD2"] + 1.25*strheight("Survives w/ S")/2,
#   col="white", border=NA)
# text(x=mydapc$grp.coord[1, "LD1"], y=mydapc$grp.coord[1, "LD2"], labels="Survives w/ S", col="#648FFF")

arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1)
text(x=1.5*mydapc$var.load[1,1], y=1.5*mydapc$var.load[1,2], labels="Light", pos=3)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1)
text(x=1.5*mydapc$var.load[2,1], y=1.5*mydapc$var.load[2,2], labels="Nitrogen", pos=4)
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1)
text(x=1.5*mydapc$var.load[3,1], y=1.5*mydapc$var.load[3,2], labels="Food", pos=4)
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[4,1], y1=1.5*mydapc$var.load[4,2], length=0.1)
# text(x=1.5*mydapc$var.load[4,1], y=1.5*mydapc$var.load[4,2], labels="Host CCM", pos=4)

legend("topright", c("Sensitive", "Tolerant", "No survival"),
col=c("#648FFF", "#FFB000", rgb(0, 0, 0)), pch=c(1, 19, 0),
bg="white")
#dev.off()
```

### Plot of the distribution of the simulated environmental variables
Colored by dominant symbiont

```{r}

par(mfrow=c(2,2))

### Light

mybreaks <- seq(5, 60, 2.5) #Otherwise it auto-includes values between 4 and 5, which we didn't simulate

hist(doc_sims$L, col="black", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(doc_sims$L[(doc_sims$dominant_symb=="Sensitive") |
	(doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_sims$L[doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Nitrogen

mybreaks <- hist(doc_sims$N, plot=FALSE)$breaks

hist(doc_sims$N, col="black", breaks=mybreaks,
	xlab="Nitrogen (mol/L)", ylab="# Simulations",
	main="Nitrogen")

hist(doc_sims$N[(doc_sims$dominant_symb=="Sensitive") |
	(doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_sims$N[doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")




### Food

mybreaks <- hist(doc_sims$X, plot=FALSE)$breaks

hist(doc_sims$X, col="black", breaks=mybreaks,
	xlab="Food (mol/L)", ylab="# Simulations",
	main="Food")

hist(doc_sims$X[(doc_sims$dominant_symb=="Sensitive") |
	(doc_sims$dominant_symb=="Tolerant")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_sims$X[doc_sims$dominant_symb=="Sensitive"],
	breaks=mybreaks, add=TRUE, col="#648FFF")

### Legend
plot.new()
legend("top", c("Sensitive symb.", "Tolerant symb.", "No survival"),
	col=c("#648FFF", "#FFB000", "black"), pch=15,
	title="Dominant symb.")


```


# Starting from a bleached state

## Set symbiont parameters

```{r bleached-pars}
# parameters for single-symbiont simulations
# sensitive symb. parameters
pars_sen <- def_pars(nsym=1)
pars_sen$initS <- 1e-4

# tolerant symb. parameters
pars_tol <- def_pars(nsym=1)
pars_tol$jCPm <- 1.0
pars_tol$kROS <- 250
pars_tol$jSGm <- 0.15
pars_tol$initS <- 1e-4

# parameters for two-symbiont simulations
# sensitive symbiont is symbiont 1; tolerant is symbiont 2
pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5e-4, 0.5e-4)
```


## No DOC

```{r no-doc-bleached-sims, cache=TRUE}
# run simulations for 100 days to determine survival
survival_time <-seq(0, 100, 0.1)

# run simulations for 1000 days to determine equilibria (if coral survives)
equil_time <- seq(0, 1000, 0.1)

# parameters to search over
search_params <- data.frame("L"=runif(150000, 5, 60),       # Light, choose values between 5 and 40
                            "N"=runif(150000, 1e-8, 1e-5),     # DIN, choose values between 0 and 6e-6
                            "X" = runif(150000, 0, 4e-7),     # Food, choose values between 0 and 4e07
                            "kCO2" = rep(10, 150000))   # Host carbon-concentrating ability, choose value of 10

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# start the timer
start <- proc.time()


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

      # initialize reason; will give the reason for lack of rescue if rescue does not occur
      # reason = "S_lives" -> host recovers with sensitive symbiont alone; does not need to be rescued by tolerant
      # reason = "T_dies" -> tolerant symbiont unable to rescue host
      # reason = "T_dominates" -> tolerant symbiont permits host recovery while sensitive does not, but tolerant dominates post-recovery
      # reason = "rescue" -> rescue occurred
      reason <- NA

    # Set up the environmental conditions
    survival_env <- coRal::init_env(time=survival_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    equil_env <- coRal::init_env(time=equil_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    # Check if the sensitive symbiont can survive alone
    run_1symb <- run_coral_rhoN(time=survival_time, env=survival_env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # if the coral can achieve positive growth with just the sensitive symbiont, the sensitive symbiont doesn't need to be rescued
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] > 0) {
          reason <- "Sensitive_alone"
    }

    # only investigate the two-symbiont case if host growth is negative or 0 at the end of the simulation
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] <= 0) {

        run_2symb <- run_coral_rhoN(time=survival_time, env=survival_env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))

        # if the coral didn't achieve positive growth with both symbionts, then rescue definitely didn't happen
        # set reason to "No_survival"
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] <= 0) {
             reason <- "No_survival"
        }

        # further investigate the case where host growth is positive at the end of the simulation
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] > 0) {

             # the sensitive symbiont (S1) has been rescued if it now has higher biomass than the tolerant symbiont (S2) at equilibrium
             # To figure out if this happened, we need to actually run things to equilibrium
             run_2symb_equil <- run_coral_rhoN(time=equil_time, env=equil_env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))


             # Check that the host and symbiont growth rates have equilibrated
             tend <- length(equil_time)
             dH <- abs(run_2symb_equil[tend - 1, "dH.Hdt"] -  run_2symb_equil[tend, "dH.Hdt"])
             dS1 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.1"] -  run_2symb_equil[tend, "dS.Sdt.1"])
             dS2 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.2"] -  run_2symb_equil[tend, "dS.Sdt.2"])
             equilibrated <- ((dH <= 1e-5) & (dS1 <= 1e-5) & (dS2 <= 1e-5))

             # if things have not equilibrated, we can't know the outcome; set reason to not_equil
             if (equilibrated == FALSE) {
                   reason <- "Not_equil"
             }

             # if things have equilibrated and there is more tolerant that sensitive symbiont, set reason to "T_dominates"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] < run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Tolerant_dominates"
             }

             # if things have equilibrated and there is more sensitive that tolerant symbiont, set reason to "rescue"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] > run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Rescue"
             }

             # if things have equilibrated to equal amounts of sensitive and tolerant symbiont (a) this is really weird and
             # (b) set reason to "possible_coexist"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] == run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Possible_coexist"
             }
        }
    }

    # return the parameters and whether rescue was successful or not
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"],
    "X"=search_params[i, "X"], "kCO2"=search_params[i, "kCO2"], "reason"=reason)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
no_doc_bleached_sims <- data.frame(results, row.names=NULL)

```

```{r no-doc-bleached-column-types, cache=FALSE}
# set the columns to their proper types
no_doc_bleached_sims <- transform(no_doc_bleached_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      reason=as.character(reason))

no_doc_bleached_sims$reason <- factor(no_doc_bleached_sims$reason, levels=c("Sensitive_alone", "No_survival", "Tolerant_dominates", "Rescue"))
```


## DOC

```{r doc-bleached-sims, cache=TRUE}
# run simulations for 100 days to determine survival
survival_time <-seq(0, 100, 0.1)

# run simulations for 1000 days to determine equilibria (if coral survives)
equil_time <- seq(0, 1000, 0.1)

# parameters to search over
search_params <- data.frame("L"=runif(150000, 5, 60),       # Light, choose values between 5 and 40
                            "N"=runif(150000, 1e-8, 1e-5),     # DIN, choose values between 0 and 6e-6
                            "X" = runif(150000, 0, 4e-7),     # Food, choose values between 0 and 4e07
                            "kCO2" = rep(10, 150000))   # Host carbon-concentrating ability, choose value of 10

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# start the timer
start <- proc.time()


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

      # initialize reason; will give the reason for lack of rescue if rescue does not occur
      # reason = "S_lives" -> host recovers with sensitive symbiont alone; does not need to be rescued by tolerant
      # reason = "T_dies" -> tolerant symbiont unable to rescue host
      # reason = "T_dominates" -> tolerant symbiont permits host recovery while sensitive does not, but tolerant dominates post-recovery
      # reason = "rescue" -> rescue occurred
      reason <- NA

    # Set up the environmental conditions
    survival_env <- coRal::init_env(time=survival_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    equil_env <- coRal::init_env(time=equil_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    # Check if the sensitive symbiont can survive alone
    run_1symb <- run_coral_oc_rhoN(time=survival_time, env=survival_env, pars=replace(pars_sen, "kCO2", search_params[i, "kCO2"]))

    # if the coral can achieve positive growth with just the sensitive symbiont, the sensitive symbiont doesn't need to be rescued
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] > 0) {
          reason <- "Sensitive_alone"
    }

    # only investigate the two-symbiont case if host growth is negative or 0 at the end of the simulation
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] <= 0) {

        run_2symb <- run_coral_oc_rhoN(time=survival_time, env=survival_env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))

        # if the coral didn't achieve positive growth with both symbionts, then rescue definitely didn't happen
        # set reason to "No_survival"
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] <= 0) {
             reason <- "No_survival"
        }

        # further investigate the case where host growth is positive at the end of the simulation
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] > 0) {

             # the sensitive symbiont (S1) has been rescued if it now has higher biomass than the tolerant symbiont (S2) at equilibrium
             # To figure out if this happened, we need to actually run things to equilibrium
             run_2symb_equil <- run_coral_oc_rhoN(time=equil_time, env=equil_env, pars=replace(pars_both, "kCO2", search_params[i, "kCO2"]))

             # Check that the host and symbiont growth rates have equilibrated
             tend <- length(equil_time)
             dH <- abs(run_2symb_equil[tend - 1, "dH.Hdt"] -  run_2symb_equil[tend, "dH.Hdt"])
             dS1 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.1"] -  run_2symb_equil[tend, "dS.Sdt.1"])
             dS2 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.2"] -  run_2symb_equil[tend, "dS.Sdt.2"])
             equilibrated <- ((dH <= 1e-5) & (dS1 <= 1e-5) & (dS2 <= 1e-5))

             # if things have not equilibrated, we can't know the outcome; set reason to not_equil
             if (equilibrated == FALSE) {
                   reason <- "Not_equil"
             }

             # if things have equilibrated and there is more tolerant that sensitive symbiont, set reason to "T_dominates"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] < run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Tolerant_dominates"
             }

             # if things have equilibrated and there is more sensitive that tolerant symbiont, set reason to "rescue"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] > run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Rescue"
             }

             # if things have equilibrated to equal amounts of sensitive and tolerant symbiont (a) this is really weird and
             # (b) set reason to "possible_coexist"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] == run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "Possible_coexist"
             }
        }
    }

    # return the parameters and whether rescue was successful or not
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"],
    "X"=search_params[i, "X"], "kCO2"=search_params[i, "kCO2"], "reason"=reason)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
doc_bleached_sims <- data.frame(results, row.names=NULL)

```

```{r doc-bleached-column-types, cache=FALSE}
# set the columns to their proper types
doc_bleached_sims <- transform(doc_bleached_sims,
      L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
      reason=as.character(reason))

doc_bleached_sims$reason <- factor(doc_bleached_sims$reason, levels=c("Sensitive_alone", "No_survival", "Tolerant_dominates", "Rescue"))
```

# DAPC plots

## No DOC

```{r, cache=FALSE}
dapc_sims <- no_doc_bleached_sims[!is.na(no_doc_bleached_sims$reason),]

mydapc <- dapc(dapc_sims[, c("L", "N", "X")], grp=dapc_sims$reason, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)
# scatter(mydapc, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE, inset.pca=TRUE,
#   col=c("#648FFF", rgb(0, 0, 0), "#FFB000", "#DC267F"), pch=c(1, 0, 19, 15), solid=0.05)
# arrows(x0=0, y0=0, x1=mydapc$var.load[1,1], y1=mydapc$var.load[1,2])
# text(x=mydapc$var.load[1,1]/2, y=mydapc$var.load[1,2]/2, labels="Light", pos=3)
# arrows(x0=0, y0=0, x1=mydapc$var.load[2,1], y1=mydapc$var.load[2,2])
# text(x=mydapc$var.load[2,1]/1, y=mydapc$var.load[2,2]/2, labels="Nitrogen", pos=4)
# arrows(x0=0, y0=0, x1=mydapc$var.load[3,1], y1=mydapc$var.load[3,2])
# text(x=mydapc$var.load[3,1]/2, y=mydapc$var.load[3,2]/2, labels="Food", pos=4)
# # arrows(x0=0, y0=0, x1=mydapc$var.load[4,1], y1=mydapc$var.load[4,2])
# # text(x=mydapc$var.load[4,1]/2, y=mydapc$var.load[4,2]/2, labels="KCO2", pos=4)
mydapc
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
summary(mydapc)
```

```{r}
#png("no_doc_dapc_bleached.png")
plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF0E", rgb(0, 0, 0, 0.025), "#FFB000", "#DC267F")[mydapc$grp], pch=c(1, 0, 19, 15)[mydapc$grp],
  xlab="DAPC axis 1", ylab="DAPC axis 2")

# rect(xleft=mydapc$grp.coord[1, "LD1"] - 1.25*strwidth("Survives w/ S")/2,
#   xright=mydapc$grp.coord[1, "LD1"] + 1.25*strwidth("Survives w/ S")/2,
#   ybottom=mydapc$grp.coord[1, "LD2"] - 1.25*strheight("Survives w/ S")/2,
#   ytop=mydapc$grp.coord[1, "LD2"] + 1.25*strheight("Survives w/ S")/2,
#   col="white", border=NA)
# text(x=mydapc$grp.coord[1, "LD1"], y=mydapc$grp.coord[1, "LD2"], labels="Survives w/ S", col="#648FFF")

arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[1,1], y=1.5*mydapc$var.load[1,2], labels="Light", pos=3, col="white")
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[2,1], y=1.5*mydapc$var.load[2,2], labels="Nitrogen", pos=4, col="white")
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[3,1], y=1.5*mydapc$var.load[3,2], labels="Food", pos=4, col="white", offset=1)

legend("topright", c("Recovers w/ S.", "Recovers w/ T.", "Rescue", "No recovery"),
col=c("#648FFF", "#FFB000", "#DC267F", rgb(0, 0, 0)), pch=c(1, 19, 15, 0),
bg="white")
#dev.off()
```

```{r}
#png("no_doc_dapc_bleached.png")
plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF0E", rgb(0, 0, 0, 0.025), "#FFB000", "#DC267F")[mydapc$grp], pch=c(1, 0, 19, 15)[mydapc$grp],
  xlab="DAPC axis 1", ylab="DAPC axis 2", xlim=c(-1, 1), ylim=c(0, 2))

# rect(xleft=mydapc$grp.coord[1, "LD1"] - 1.25*strwidth("Survives w/ S")/2,
#   xright=mydapc$grp.coord[1, "LD1"] + 1.25*strwidth("Survives w/ S")/2,
#   ybottom=mydapc$grp.coord[1, "LD2"] - 1.25*strheight("Survives w/ S")/2,
#   ytop=mydapc$grp.coord[1, "LD2"] + 1.25*strheight("Survives w/ S")/2,
#   col="white", border=NA)
# text(x=mydapc$grp.coord[1, "LD1"], y=mydapc$grp.coord[1, "LD2"], labels="Survives w/ S", col="#648FFF")

arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[1,1], y=1.5*mydapc$var.load[1,2], labels="Light", pos=3, col="white")
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[2,1], y=1.5*mydapc$var.load[2,2], labels="Nitrogen", pos=4, col="white")
arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1, col="white")
text(x=1.5*mydapc$var.load[3,1], y=1.5*mydapc$var.load[3,2], labels="Food", pos=4, col="white", offset=1)

legend("topright", c("Recovers w/ S.", "Recovers w/ T.", "Rescue", "No recovery"),
col=c("#648FFF", "#FFB000", "#DC267F", rgb(0, 0, 0)), pch=c(1, 19, 15, 0),
bg="white")
#dev.off()
```

### Plot of the distribution of the simulated environmental variables
Colored by post-bleaching outcome

```{r}

par(mfrow=c(2,2))

### Light

mybreaks <- seq(5, 60, 2.5) #Otherwise it auto-includes values between 4 and 5, which we didn't simulate

hist(no_doc_bleached_sims$L, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(no_doc_bleached_sims$L[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="Tolerant_dominates") | (no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_bleached_sims$L[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(no_doc_bleached_sims$L[no_doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")

### Nitrogen

mybreaks <- hist(no_doc_bleached_sims$N, plot=FALSE)$breaks

hist(no_doc_bleached_sims$N, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(no_doc_bleached_sims$N[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="Tolerant_dominates") | (no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_bleached_sims$N[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(no_doc_bleached_sims$N[no_doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")


### Food

mybreaks <- hist(no_doc_bleached_sims$X, plot=FALSE)$breaks

hist(no_doc_bleached_sims$X, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(no_doc_bleached_sims$X[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="Tolerant_dominates") | (no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(no_doc_bleached_sims$X[(no_doc_bleached_sims$reason=="Sensitive_alone") |
	(no_doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(no_doc_bleached_sims$X[no_doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")

### Legend
plot.new()
legend("top", c("Recovers w/ S.", "Recovers w/ T.", "Rescue", "No recovery"),
	col=c("#648FFF", "#FFB000", "#DC267F", "black"), pch=15)


```


## DOC

```{r}
dapc_sims <- doc_bleached_sims[!is.na(doc_bleached_sims$reason),]

mydapc <- dapc(dapc_sims[, c("L", "N", "X")], grp=dapc_sims$reason, var.contrib=TRUE, var.loadings=TRUE, scale = TRUE, n.pca = 4, n.da = 3)
# scatter(mydapc, cell = 0, cstar = 0, mstree = FALSE, lwd = 2, lty = 2, axesell=TRUE, scree.da=FALSE, inset.pca=TRUE,
#   col=c("#648FFF", rgb(0, 0, 0), "#FFB000", "#DC267F"), pch=c(1, 0, 19, 15), solid=0.05)
# arrows(x0=0, y0=0, x1=mydapc$var.load[1,1], y1=mydapc$var.load[1,2])
# text(x=mydapc$var.load[1,1]/2, y=mydapc$var.load[1,2]/2, labels="Light", pos=3)
# arrows(x0=0, y0=0, x1=mydapc$var.load[2,1], y1=mydapc$var.load[2,2])
# text(x=mydapc$var.load[2,1]/1, y=mydapc$var.load[2,2]/2, labels="Nitrogen", pos=4)
# arrows(x0=0, y0=0, x1=mydapc$var.load[3,1], y1=mydapc$var.load[3,2])
# text(x=mydapc$var.load[3,1]/2, y=mydapc$var.load[3,2]/2, labels="Food", pos=4)
# # arrows(x0=0, y0=0, x1=mydapc$var.load[4,1], y1=mydapc$var.load[4,2])
# # text(x=mydapc$var.load[4,1]/2, y=mydapc$var.load[4,2]/2, labels="KCO2", pos=4)
mydapc
mydapc$loadings
mydapc$var.load
mydapc$pca.loadings
summary(mydapc)
```


```{r}
# plot(mydapc$ind.coord[,"LD1"], mydapc$ind.coord[,"LD2"], col=c("#648FFF0E", rgb(0, 0, 0, 0.05), "#FFB000", "#DC267F")[mydapc$grp], pch=c(1, 0, 19, 15)[mydapc$grp],
#   xlab="DAPC axis 1", ylab="DAPC axis 2")
#
# # rect(xleft=mydapc$grp.coord[1, "LD1"] - 1.25*strwidth("Survives w/ S")/2,
# #   xright=mydapc$grp.coord[1, "LD1"] + 1.25*strwidth("Survives w/ S")/2,
# #   ybottom=mydapc$grp.coord[1, "LD2"] - 1.25*strheight("Survives w/ S")/2,
# #   ytop=mydapc$grp.coord[1, "LD2"] + 1.25*strheight("Survives w/ S")/2,
# #   col="white", border=NA)
# # text(x=mydapc$grp.coord[1, "LD1"], y=mydapc$grp.coord[1, "LD2"], labels="Survives w/ S", col="#648FFF")
#
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[1,1], y1=1.5*mydapc$var.load[1,2], length=0.1)
# text(x=1.5*mydapc$var.load[1,1], y=1.5*mydapc$var.load[1,2]/2, labels="Light", pos=3)
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[2,1], y1=1.5*mydapc$var.load[2,2], length=0.1)
# text(x=1.5*mydapc$var.load[2,1]/1, y=1.5*mydapc$var.load[2,2]/2, labels="Nitrogen", pos=4)
# arrows(x0=0, y0=0, x1=1.5*mydapc$var.load[3,1], y1=1.5*mydapc$var.load[3,2], length=0.1)
# text(x=1.5*mydapc$var.load[3,1]/2, y=1.5*mydapc$var.load[3,2]/2, labels="Food", pos=1, offset=1)
#
# legend("topright", c("Recovers w/ S.", "Recovers w/ T.", "Rescue", "No recovery"),
# col=c("#648FFF", "#FFB000", "#DC267F", rgb(0, 0, 0)), pch=c(1, 19, 15, 0),
# bg="white")
```

### Plot of the distribution of the simulated environmental variables
Colored by post-bleaching outcome

```{r}

par(mfrow=c(2,2))

### Light

mybreaks <- seq(5, 60, 2.5) #Otherwise it auto-includes values between 4 and 5, which we didn't simulate

hist(doc_bleached_sims$L, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(doc_bleached_sims$L[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="Tolerant_dominates") | (doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_bleached_sims$L[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(doc_bleached_sims$L[doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")

### Nitrogen

mybreaks <- hist(doc_bleached_sims$N, plot=FALSE)$breaks

hist(doc_bleached_sims$N, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(doc_bleached_sims$N[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="Tolerant_dominates") | (doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_bleached_sims$N[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(doc_bleached_sims$N[doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")


### Food

mybreaks <- hist(doc_bleached_sims$X, plot=FALSE)$breaks

hist(doc_bleached_sims$X, col="#DC267F", breaks=mybreaks,
	xlab="Light (mol photons/m^2/day)", ylab="# Simulations",
	main="Light")

hist(doc_bleached_sims$X[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="Tolerant_dominates") | (doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#FFB000")

hist(doc_bleached_sims$X[(doc_bleached_sims$reason=="Sensitive_alone") |
	(doc_bleached_sims$reason=="No_survival")],
	breaks=mybreaks, add=TRUE, col="#648FFF")

hist(doc_bleached_sims$X[doc_bleached_sims$reason=="No_survival"],
	breaks=mybreaks, add=TRUE, col="black")

### Legend
plot.new()
legend("top", c("Recovers w/ S.", "Recovers w/ T.", "Rescue", "No recovery"),
	col=c("#648FFF", "#FFB000", "#DC267F", "black"), pch=15)


```

# C and N limitation during rescue (DOC)

```{r}
# Let's make a sweet function that returns limitation for hosts and symbionts!
# Input:
#   - run, a coRal:run_coral or coRal::run_coral_oc simulation
#   - pars, the host and symbiont parameters used for run (coRal::def_pars format)
cn_limitation <- function(run, pars) {
  # Initialize the list of limitation values to be returned
  limList <- list()

  # Get the number of symbionts
  nsym <- length(pars$initS)

  ### If there is only one symbiont
  if(nsym == 1) {

    ## Symbiont
    # inputs to symbiont growth SU
    symbC <- pars$yC * run$jCP # carbon input
    symbN <- (run$rhoN * run$H/run$S + run$rNS)/pars$nNS # nitrogen input

    # Symbiont C/N limitation (positive = n-limited, negative = c-limited)
    symbLim <- log(pmin(symbC, pars$jSGm) / pmin(symbN, pars$jSGm))
    limList$S <- symbLim # add symbiont C/N limitation to the output


    ## Host
    # inputs to the host growth SU
    hostC <- pars$yC * run$rhoC * run$S / run$H + run$jX # carbon input
    hostN <- (run$jN + pars$nNX * run$jX + run$rNH) / pars$nNH # nitrogen input

    # Host C/N limitation
    hostLim <- log(pmin(hostC, pars$jHGm) / pmin(hostN, pars$jHGm))
    limList$H <- hostLim # add host C/N limitation to the output
  }

  ### If there are multiple symbionts
  if(nsym > 1) {

    ## Symbiont
    for(i in 1:nsym) {
      # Inputs symbiont i's growth SU
      symbC <- pars$yC * run[[paste0("jCP.", i)]] # carbon input
      symbN <- (run$rhoN * run$H/run[[paste0("S.", i)]] + run[[paste0("rNS.", i)]])/pars$nNS[i] # nitrogen input

      # Symbiont i's C/N limitation
      symbLim <- log(pmin(symbC, pars$jSGm[i]) / pmin(symbN, pars$jSGm[i]))
      limList[[paste0("S.", i)]] <- symbLim # add symb. i's C/N limitation to the output
    }

    ## Host
    # carbon from symbiont i to host
    csymbi <- sapply(1:nsym, function(i) {
        run[[paste0("rhoC.", i)]] * run[[paste0("S.", i)]]
      })

    # total carbon from symbionts to host
    csymbtot <- apply(csymbi, 1, sum)

    # carbon input to host growth SU
    hostC <- pars$yC * csymbtot / run$H + run$jX

    # nitrogen input to host grwoth SU
    hostN <- (run$jN + pars$nNX * run$jX + run$rNH) / pars$nNH

    # Host C/N limitation
    hostLim <- log(pmin(hostC, pars$jHGm) / pmin(hostN, pars$jHGm))
    limList$H <- hostLim # add host C/N limitation to the output
  }

  return(limList)
}
```

Positive C/N-limitation means N-limited (like Figure 9))
Why doesn't this become positive when host growth becomes positive?

```{r}
rescue_sims <- doc_bleached_sims[doc_bleached_sims$reason=="Rescue" & !is.na(doc_bleached_sims$reason),]

pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5e-4, 0.5e-4)

time <- seq(0, 365, 0.1)

par(mfcol=c(3, 3))
for (i in 1:min(30, nrow(rescue_sims))) {
  Li <- rescue_sims[i, "L"]
  Ni <- rescue_sims[i, "N"]
  Xi <- rescue_sims[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))

  run <- run_coral_oc_rhoN(time=time, env=env, pars=pars_both)

  cnlim <- cn_limitation(run, pars_both)

  minlim <- min(cnlim$S.1, cnlim$S.2, cnlim$H)
  maxlim <- max(cnlim$S.1, cnlim$S.2, cnlim$H)

  plot(time, cnlim$S.1, type="l", col="#648FFF", xlab="time (days)", ylab="C/N limitation",
      main=paste("Sim", i), ylim=c(minlim, maxlim))
  lines(time, cnlim$S.2, col="#FFB000")
  lines(time, cnlim$H, col="black")

  if (i == 1) {
    legend("left", c("S. symb", "T. symb", "host"), col=c("#648FFF", "#FFB000", "black"),
      lty=1)
  }

  minSH <- min(run$S.1/run$H, run$S.2/run$H)
  maxSH <- max(run$S.1/run$H, run$S.2/run$H)

  plot(time, run$S.1/run$H, type="l", col="#648FFF", xlab="time (days)", ylab="S/H ratio",
    main=paste("Sim", i), ylim=c(minSH, maxSH), log="y")
  lines(time, run$S.2/run$H, col="#FFB000")

  plot(time, run$dH.Hdt, type="l", col="black", xlab="time (days)", ylab="dH/Hdt",
    main=paste("Sim", i), ylim=c(-0.04, 0.04))
  lines(time, rep(0, length(time)))
}


plotted_sims <- rescue_sims[1:30, c("L", "N", "X")]
rownames(plotted_sims) <- lapply(1:nrow(plotted_sims), function(x) {paste("Sim", x)})
knitr::kable(plotted_sims, "html", col.names=c("Light (mol photons/m^2/day)", "Nitrogen (mol/L)", "Food (mol/L)"), row.names=TRUE,
  label="Environmental parameters for above simulations",
  caption="Light, dissolved inorganic nitrogen, and food levels for simulations plotted above",
  digits=c(4, 11, 12))

```


### C-N limitation after the transition to positive host growth (DOC)
This "should" be positive (N-limited) but isn't

```{r}
rescue_sims <- doc_bleached_sims[doc_bleached_sims$reason=="Rescue" & !is.na(doc_bleached_sims$reason),]
cnlimH <- rep(NA, nrow(rescue_sims))
cnlimS.1 <- rep(NA, nrow(rescue_sims))
cnlimS.2 <- rep(NA, nrow(rescue_sims))
maxSenH <- rep(NA, nrow(rescue_sims)) # maximum sensitive symb: host ratio AFTER return to positive host growth
maxTolH <- rep(NA, nrow(rescue_sims)) # same as above but for tolerant symb: host ratio

for(i in 1:nrow(rescue_sims)) {
  Li <- rescue_sims[i, "L"]
  Ni <- rescue_sims[i, "N"]
  Xi <- rescue_sims[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))

  run <- run_coral_oc_rhoN(time=time, env=env, pars=pars_both)

  cnlim <- cn_limitation(run, pars_both)

  posGrIndex <- seq(1, length(run$time))[max(run$time[run$dH.Hdt < 0])] + 2

  cnlimH[[i]] <- cnlim$H[posGrIndex]
  cnlimS.1[[i]] <- cnlim$S.1[posGrIndex]
  cnlimS.2[[i]] <- cnlim$S.2[posGrIndex]

  maxSenH[[i]] <- max((run$S.1/run$H)[seq(1, length(run$H)) >= posGrIndex])
  maxTolH[[i]] <- max((run$S.2/run$H)[seq(1, length(run$H)) >= posGrIndex])

  if(i == 1) {
    plot(seq(0, max(run$time) - time[posGrIndex], 0.1), cnlim$S.1[posGrIndex:length(cnlim$S.1)],
      xlim=c(0, max(run$time)), ylim=c(-2, 2), type="l", col="#648FFF80", xlab="Time since return to positive growth",
      ylab = "C-N limitation")
    lines(seq(0, max(run$time) - time[posGrIndex], 0.1), cnlim$S.2[posGrIndex:length(cnlim$S.2)],
      col="#FFB00080")
      legend("topright", c("Sensitive symb.", "Tolerant symb"), col=c("#648FFF", "#FFB000"))
  } else {
    lines(seq(0, max(run$time) - time[posGrIndex], 0.1), cnlim$S.1[posGrIndex:length(cnlim$S.1)],
      col="#648FFF80")
    lines(seq(0, max(run$time) - time[posGrIndex], 0.1), cnlim$S.2[posGrIndex:length(cnlim$S.2)],
      col="#FFB00080")
  }
}

rescue_sims$cnlimH <- as.numeric(cnlimH)
rescue_sims$cnlimS.1 <- as.numeric(cnlimS.1)
rescue_sims$cnlimS.2 <- as.numeric(cnlimS.2)
rescue_sims$maxSenH <- as.numeric(maxSenH)
rescue_sims$maxTolH <- as.numeric(maxTolH)


rownames(rescue_sims) <- lapply(1:nrow(rescue_sims), function(x) {paste("Sim", x)})

knitr::kable(rescue_sims[, c("L", "N", "X", "cnlimH", "cnlimS.1", "cnlimS.2", "maxSenH", "maxTolH")],
"html", col.names=c("Light", "Nitrogen", "Food",
"Host C-N lim.", "Sens. symb. C-N lim.", "Tol. symb. C-N lim.", "Max. Sen:H", "Max. Tol:H"), row.names=TRUE,
  label="C-N limitation immediately after achieving positive host growth",
  caption="Positive C-N limitation indicates N limitation (expected but not what we see).\nLimitation for 2 time steps (0.2 days) after the last time the host shows negative growth.\nMax Sen:H and Tol:H are maximum sensitive and tolerant symbiont:host ratios taken over all points AFTER the last time the host shows negative growth.",
  digits=c(4, 11, 12, 3, 3, 3, 3, 3))
```


### C-N limitation in healthy hosts (DOC)
This "should" be positive (N-limited) but isn't

```{r}
pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5, 0.5)

time <- seq(0, 600, 0.1)

cnlim_sims <- doc_sims[(doc_sims$dominant_symb != "No_survival"),]
cnlim_sims <- cnlim_sims[1:min(nrow(cnlim_sims), 30),] # there's going to be a lot of these; trim them down

par(mfcol=c(3, 3))
for (i in 1:nrow(cnlim_sims)) {
  Li <- cnlim_sims[i, "L"]
  Ni <- cnlim_sims[i, "N"]
  Xi <- cnlim_sims[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))

  run <- run_coral_oc_rhoN(time=time, env=env, pars=pars_both)

  cnlim <- cn_limitation(run, pars_both)

  minlim <- min(cnlim$S.1, cnlim$S.2, cnlim$H)
  maxlim <- max(cnlim$S.1, cnlim$S.2, cnlim$H)

  plot(time, cnlim$S.1, type="l", col="#648FFF", xlab="time (days)", ylab="C/N limitation",
      main=paste("Sim", i), ylim=c(minlim, maxlim))
  lines(time, cnlim$S.2, col="#FFB000")
  lines(time, cnlim$H, col="black")

  if (i == 1) {
    legend("left", c("S. symb", "T. symb", "host"), col=c("#648FFF", "#FFB000", "black"),
      lty=1)
  }

  minSH <- min(run$S.1/run$H, run$S.2/run$H)
  maxSH <- max(run$S.1/run$H, run$S.2/run$H)

  plot(time, run$S.1/run$H, type="l", col="#648FFF", xlab="time (days)", ylab="S/H ratio",
    main=paste("Sim", i), ylim=c(minSH, maxSH), log="y")
  lines(time, run$S.2/run$H, col="#FFB000")

  plot(time, run$dH.Hdt, type="l", col="black", xlab="time (days)", ylab="dH/Hdt",
    main=paste("Sim", i), ylim=c(-0.04, 0.04))
  lines(time, rep(0, length(time)))
}


rownames(cnlim_sims) <- lapply(1:nrow(cnlim_sims), function(x) {paste("Sim", x)})
knitr::kable(cnlim_sims[,c("L", "N", "X")], "html", col.names=c("Light (mol photons/m^2/day)", "Nitrogen (mol/L)", "Food (mol/L)"), row.names=TRUE,
  label="Environmental parameters for above simulations",
  caption="Light, dissolved inorganic nitrogen, and food levels for simulations plotted above",
  digits=c(4, 11, 12))
```
