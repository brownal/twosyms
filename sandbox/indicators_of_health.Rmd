---
title: "Investigating possible indicators of coral recovery from bleaching"
author: "Alexandra Brown and Ross Cunning"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
      html_document:
            code_folding: hide
---

```{r set-options}
# Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, fig.width=8, fig.height=8, results='hold')

# Load packages
library("coRal")
library("foreach")
library("parallel")
library("doParallel")
library("MASS")
library("adegenet")
library("knitr")

# Plot size for running this in-line
options(repr.plot.res=240)

# Load functions
source("cn_limitation.R") # calculates carbon/nitrogen of biomass SU
source("light_limitation.R")
```

# Abstract

We investigate 3 possible measures of a bleached host's return to health,
as well as combinations of these measures:

* Host has achieved positive growth at day 100 post-bleaching
* Host is not carbon-limited at day 100 post-bleaching
* Symbiont is not carbon-limited at day 100 post-bleaching

We want to know:

1. Do these measures often detect cases with high overshoot (symbiont:host ratio is very high)?
    + High overshoot _might_ indicate the host isn't actually healthy
2. Does the "recovery" process of healthy hosts look like the hosts are actually healthy?
3. Do any indicators look they might be particularly helpful or redundant?

We found:

1. Overshoot
    + Hosts that are not carbon-limited tend to not show extremely high symbiont:host ratios
    + Even with all the indicators combined, we're still seeing cases with S:H ratio around 0.4
    + I personally think this might be okay
2. Recovery process (time series)
    + Ask Ross; nothing looks terrible to me of the indicators I checked
    + I checked positive growth, positive growth + host and/or symbiont not C-limited
3. Particularly helpful/redundant indicators
    + Host not carbon-limited on day 100 captures a range of S:H ratios that's neither too small
      (possibly actually bleached) or too large (possible unrealistic overshoot)
        - Hosts that are not carbon-limited nearly always also exhibit positive growth (99.9% of the time)
        - Hosts in the sample simulations generally leave carbon limitation before symbionts
    + Positive growth definitely seems conceptually important, if not as useful
        - Hosts that exhibit positive growth frequently are not carbon-limited (90% of the time)
        - Similarly, their symbionts are also generally not carbon-limited (95% of the time)
    + Symbionts are frequently not carbon-limited
        - Possibly symbionts not being carbon-limited is conceptually important, though

# Simulate bleached hosts

```{r set-bleached-pars}
## Parameters for single-symbiont simulations ##
# Sensitive symb. parameters
pars_sen <- def_pars(nsym=1)
pars_sen$initS <- 1e-4

# Tolerant symb. parameters
pars_tol <- def_pars(nsym=1)
pars_tol$jCPm <- 1.0
pars_tol$kROS <- 250
pars_tol$jSGm <- 0.15
pars_tol$initS <- 1e-4

## Parameters for two-symbiont simulations ##
# Sensitive symbiont is symbiont 1; tolerant is symbiont 2
pars_both <- def_pars(nsym=2)
pars_both$jCPm[2] <- 1.0
pars_both$kROS[2] <- 250
pars_both$jSGm[2] <- 0.15
pars_both$initS[1:2] <- c(0.5e-4, 0.5e-4)
```

```{r run-sims, cache=TRUE}
## Run the simulations and record various possible indicators of a healthy host ##

# run simulations for 100 days to determine survival
time <-seq(0, 100, 0.1)


# randomly draw environments to simulate corals in
env_params <- data.frame("L"=runif(150000, 5, 60),       # Light, draw values between 5 and 60 mol photons/m^2/day
                            "N"=10^runif(150000, -8, -5),     # Dissolved inorganic nitrogen, draw values between 10^-8 and 10^-5 mol/L
                            "X" = 10^runif(150000, -8, -6.4))     # Food, draw values between 10^-8 and 10^-6.4 (about 4*10^-7) mol/L

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)


# results will temporarily hold the summary statistics from the simulations
results <- foreach(i=1:nrow(env_params), .combine='rbind', .packages='dplyr') %dopar% {

  # Set up the environmental conditions
  env <- coRal::init_env(time=time, L=c(env_params[i, "L"], env_params[i, "L"], 0),
    N=c(env_params[i, "N"], env_params[i, "N"], 0), X=c(env_params[i, "X"], env_params[i, "X"], 0))

  # Run the simulation
  run <- coRal::run_coral(time=time, env=env, pars=pars_both)

  # Calculate C-N limitation
  cnlim <- cn_limitation(run, pars_both)

  # Calculate CO2-light limitation
  #cllim <- light_limitation(run, pars_both)

  # Possible measures of recovery from bleaching: host growth, host nitrogen limitation,
  # and lack of symbiont carbon limitation
  posGrH <- (run$dH.Hdt[length(time)] > 0) # is host growth positive?
  noClimH <- (cnlim$H[length(time)] >= 0) # is host NOT carbon-limited?
  noClimS.1 <- (cnlim$S.1[length(time)] >= 0) # is the sensitive symb. NOT carbon-limited?
  noClimS.2 <- (cnlim$S.2[length(time)] >= 0) # is the tolerant symb. NOT carbon-limited?
  shEnd <- (run$S.1[length(time)] + run$S.2[length(time)]) / run$H[length(time)]
  shMax <- max((run$S.1 + run$S.2) / run$H)

  # Possible measures of recovery from bleaching: host growth and light-limited photosynthesis
  # lightLim.1 <- any(cllim$S.1 > 0)
  # lightLim.2 <- any(cllim$S.2 > 0)
  # lightLim <- any((cllim$S.1 > 0) & (cllim$S.2 > 0))
  # posGrH_lightLim <- any((run$dH.Hdt > 0) & (cllim$S.1 > 0) & (cllim$S.2 > 0))

  # Return the environmental parameters & possible measures of recovery from bleaching
  list("L"=env_params[i, "L"], "N"=env_params[i, "N"], "X"=env_params[i, "X"],
    "posGrH"=posGrH, "noClimH"=noClimH, "noClimS.1"=noClimS.1, "noClimS.2"=noClimS.2,
    "shEnd"=shEnd, "shMax"=shMax)
}

stopCluster(cl) # stop the cluster

# Store results in dataframe, as type numeric
sim_bleached <- data.frame(results, row.names=NULL)
sim_bleached <- lapply(sim_bleached, as.numeric)
```


# Summary stats
## Possible indicators of health

What fraction of the time did each indicator label the host as healthy at day 100?

```{r summarize-indicator-mean}
sim_bleached <- as.data.frame(sim_bleached)

# The possible indicators of recovery to a "healthy state"
indicators <- sim_bleached[, !(names(sim_bleached) %in% c("L", "X", "N", "shEnd", "shMax"))]

# Add in combinations of the indicators
indicators$noClimS <- indicators$noClimS.1 * indicators$noClimS.2
indicators$posGrH_noClimH <- indicators$posGrH * indicators$noClimH
indicators$posGrH_noClimS <- indicators$posGrH * indicators$noClimS
indicators$noClimAll <- indicators$noClimH * indicators$noClimS
indicators$posGrH_noClimAll <- indicators$posGrH * indicators$noClimAll

# Get the mean for each indicator (fraction of times it indicated a healthy host)
indicators_mean <- lapply(indicators, mean)
print(indicators_mean)
```

## Symbiont:host ratio

We have two measures of the symbiont:host ratio:
the maximum symbiont:host ratio and the symbiont:host ratio at 100 days.

These could theoretically answer slightly different questions

1. How high is the overshoot in corals that ultimately end up healthy vs not?
2. Do some host declared healthy actually have a really high symbiont:host ratio?

However, they're both pretty much the same.

```{r summarize-maxSH}
print("Maximum S:H ratio summary statistics")
print(summary(sim_bleached$shMax))

print("S:H ratio at 100 days summary statistics")
print(summary(sim_bleached$shEnd))

print("Fraction of cases where maximum S:H ratio and S:H ratio at 100 days are equal")
print(sum(sim_bleached$shMax == sim_bleached$shEnd)/nrow(sim_bleached))
```

# Distribution of maximum symbiont:host ratio (possible overshoot) for each indicator of health
Distribution of maximum S:H ratio for all simulations in gray for comparison.

```{r function-plotIndicatorHist}
# This function will plot a histogram of the data (ideally the S:H ratios that meet a particular health indicator)
# overlaid on a second pre-made histogram for comparison (comparisonHist)

plotIndicatorHist <- function(data, comparisonHist, title, xlab, ylab, ...) {
  plotargs <- list(...)

	# Make the histogram for the indicator
	indicatorHist <- hist(data, breaks=comparisonHist$breaks, plot=FALSE)

	# Set bar heights to be the % of the simulations which the indicator deems healthy (i.e. nrow(data))
	indicatorHist$density <- indicatorHist$counts / sum(indicatorHist$counts) * 100

	# Plot the comparison histogram
	do.call(plot, c(list(comparisonHist, freq=FALSE, col=rgb(0, 0, 0, 0.25), main=title, xlab=xlab, ylab=ylab), plotargs))

	# Plot indicator histogram
	plot(indicatorHist, add=TRUE, freq=FALSE, col="#648FFF40")

	# Add a legend
	legend("topright", c("All simulations", title), pt.bg=c(rgb(0, 0, 0, 0.75), "#648FFFC0"), col="black", pch=22)
}


```

```{r shMax-histograms}
# Histogram of maximum S:H ratio for all simulations
shMaxHist <- hist(sim_bleached$shMax, plot=FALSE)
breaks <- shMaxHist$breaks
shMaxHist$density <- shMaxHist$counts / sum(shMaxHist$counts) * 100

par(mfrow=c(2,2))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH == 1], comparison=shMaxHist,
  title="Positive host growth", xlab="S:H ratio", ylab="# simulations")

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimH == 1], comparison=shMaxHist,
  title="Host is not carbon-limited", xlab="S:H ratio", ylab="# simulations")

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimS == 1], comparison=shMaxHist,
  title="Symbionts are not C-limited", xlab="S:H ratio", ylab="# simulations", ylim=c(0, 80))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimH == 1], comparison=shMaxHist,
  title="Host is growing & not C-lim.", xlab="S:H ratio", ylab="# simulations")

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimS == 1], comparison=shMaxHist,
  title="Host is growing & symbs. are not C-lim.", xlab="S:H ratio", ylab="# simulations")

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimAll == 1], comparison=shMaxHist,
  title="Neither host nor symbs. are C-lim.", xlab="S:H ratio", ylab="# simulations")

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimAll == 1], comparison=shMaxHist,
  title="Host is growing, host & symbs. are not C-lim.", xlab="S:H ratio", ylab="# simulations")
```

## Zoom in on high S:H region of the above histograms

```{r high-shMax-histograms}
# Histogram of maximum S:H ratio for all simulations
shMaxHist <- hist(sim_bleached$shMax, plot=FALSE)
breaks <- shMaxHist$breaks
shMaxHist$density <- shMaxHist$counts / sum(shMaxHist$counts) * 100

par(mfrow=c(2,2))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH == 1], comparison=shMaxHist,
  title="Positive host growth", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimH == 1], comparison=shMaxHist,
  title="Host is not carbon-limited", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimS == 1], comparison=shMaxHist,
  title="Symbionts are not C-limited", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimH == 1], comparison=shMaxHist,
  title="Host is growing & not C-lim.", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimS == 1], comparison=shMaxHist,
  title="Host is growing & symbs. are not C-lim.", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$noClimAll == 1], comparison=shMaxHist,
  title="Neither host nor symbs. are C-lim.", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))

plotIndicatorHist(data=sim_bleached$shMax[indicators$posGrH_noClimAll == 1], comparison=shMaxHist,
  title="Host is growing, host & symbs. are not C-lim.", xlab="S:H ratio", ylab="# simulations",
  xlim=c(0.3, 0.7), ylim=c(0, 10))
```

# Selected simulations that show different indicators of health

## Positive host growth

```{r def-plotting-function, cache=TRUE}
# A function make some pretty plots
# Input:
#  - run: a run_coral simulation
#  - pars: parameters used to run the simulation (coRal::def_pars format)
#  - i: a number/string to label the plots with
#
# Output:
#  - Plot of host growth rate (dH/Hdt)
#  - Plot of symbiont/host ratio
#  - Plot of C/N limitation
#  - Plot of CO2/light limitation

niceplots <- function(run, pars, i) {

  # Calculate C/N and CO2/light limitation
  cnlim <- cn_limitation(run, pars_both)
  cllim <- light_limitation(run, pars_both)

  # Find the min and max values of the things we'll plot
  mincnlim <- min(unlist(lapply(cnlim, min)), 0)
  maxcnlim <- max(unlist(lapply(cnlim, max)), 0)

  mincllim <- min(unlist(lapply(cllim, min)), 0)
  maxcllim <- max(unlist(lapply(cllim, max)), 0)

  minSH <- min(run$S.1/run$H, run$S.2/run$H)
  maxSH <- max(run$S.1/run$H, run$S.2/run$H)

  minGr <- min(run$dH.Hdt[-1], 0)
  maxGr <- max(run$dH.Hdt[-1], 0)

  # Plot host growth rate
  plot(run$time[-1], rep(0, length(run$time)-1), type="l", col="gray", ylim=c(minGr, maxGr),
    main=paste0("Sim ", i, ": dH/Hdt"), xlab="time (days)", ylab="dH/Hdt") # Put a line at gr = 0
  lines(run$time[-1], run$dH.Hdt[-1])

  # Plot symbiont/host ratio
  plot(run$time[-1], run$S.1[-1]/run$H[-1], type="l", col="#648FFF", xlab="time (days)", ylab="S/H ratio",
    main=paste0("Sim ", i, ": S/H"), ylim=c(minSH, maxSH))
  lines(time, run$S.2/run$H, col="#FFB000")

  # Plot C/N limitation
  plot(run$time[-1], cnlim$S.1[-1], type="l", col="#648FFF", xlab="time (days)", ylab="C/N limitation",
      main=paste0("Sim ", i, ": C/N lim"), ylim=c(mincnlim, maxcnlim))
  lines(time, cnlim$S.2, col="#FFB000")
  lines(time, cnlim$H, col="black")

  # Plot CO2/light limitation
  # plot(run$time[-1], cllim$S.1[-1], type="l", col="#648FFF", xlab="time (days)", ylab="C/N limitation",
  #     main=paste0("Sim ", i, ": Light lim"), ylim=c(mincllim, maxcllim))
  # lines(time, cllim$S.2, col="#FFB000")
}
```

## Host shows positive growth

```{r timeseries-posGrH}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[(indicators$posGrH == 1)]
sims <- sample(sims, min(4, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)

  if (i == min(sims)) {
    legend("bottomright", c("S. symb", "T. symb", "host"), col=c("#648FFF", "#FFB000", "black"),
      lty=1)
  }
}
```

### Host shows positive growth, but NOT the other indicators (i.e. host & symbs are C-limited)

```{r timeseries-posGrH-ONLY}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[((indicators$posGrH == 1) & (!indicators$noClimH == 1) & !(indicators$noClimS.1 == 1) & !(indicators$noClimS.2 == 1))]
sims <- sample(sims, min(4, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)

  if (i == min(sims)) {
    legend("bottomright", c("S. symb", "T. symb", "host"), col=c("#648FFF", "#FFB000", "black"),
      lty=1)
  }
}
```


## Host is growing and not carbon-limited

```{r timeseries-posGrH-noClimH}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[(indicators$posGrH_noClimH == 1)]
sims <- sample(sims, min(4, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)
}
```


### Host is growing and not carbon-limited, but symbionts ARE carbon-limited
This doesn't happen in this set of simulations!

```{r posGrH-noClimH-ONLY}

print("Simulations where host is growing & not C-limited but symbionts ARE C-limited")
print(sum((indicators$posGrH_noClimH==1) & !(indicators$noClimS.1 == 1) & !(indicators$noClimS.2 == 1)))

```



## Host is growing, symbionts are not carbon-limited

```{r timeseries-posGrH-noClimS}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[(indicators$posGrH_noClimS == 1)]
sims <- sample(sims, min(4, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)
}
```

### Host is growing, symbionts are not carbon-limited, but host IS carbon-limited

```{r timeseries-posGrH-noClimS-ONLY}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[((indicators$posGrH_noClimS == 1) & !(indicators$noClimH == 1))]
sims <- sample(sims, min(4, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)
}
```


## Host is growing, hosts and symbiont are not carbon-limited

```{r timeseries-posGrH-noClimAll}
par(mfrow=c(4, 3))

time <- seq(0, 150, 0.1)

sims <- seq(1:nrow(sim_bleached))[(indicators$posGrH_noClimAll == 1)]
sims <- sample(sims, min(12, nrow(sims)))
sims <- sort(sims)

for (i in sims) {
  Li <- sim_bleached[i, "L"]
  Ni <- sim_bleached[i, "N"]
  Xi <- sim_bleached[i, "X"]

  env <- init_env(time=time, L=c(Li, Li, 0), N=c(Ni, Ni, 0), X=c(Xi, Xi, 0))
  run <- run_coral(time=time, env=env, pars=pars_both)

  niceplots(run, pars_both, i)
}
```

# Next steps
The next step (in another document) is to look at the cases of rescue these indicators detect.

* How many cases do they detect?
* How consistent are cases detected by different indicators?
* Do we think the cases they're detecting are good representations of "real" rescue?
* What can the dynamics of the rescue cases tell us about the cause of rescue?
