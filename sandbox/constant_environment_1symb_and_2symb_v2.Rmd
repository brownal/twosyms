---
title: "Symbiont shuffling in a constant environment"
author: "Ross Cunning and Alexandra Brown"
date: "3/26/2020"
output: html_document
---

```{r setup, include=FALSE}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, fig.width=8, fig.height=8)

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")

options(repr.plot.res=240)
```
# Food = 0


## One symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001))

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

initSHsweepOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    run <- coRal::run_coral_ss(env=list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "X"=0), 
                               pars=replace(coRal::def_pars(), "initS", inputDF[i, "initSH"]))
    gr <- run$H$dH.Hdt[length(run$H$dH.Hdt)]
    finalSH <- run$S$S[length(run$S$S)] / run$H$H[length(run$H$H)]
    endTime <- (length(run$H$H) - 1)*run$dt
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "gr"=gr, "finalSH"=finalSH, "endTime"=endTime)
}

stopCluster(cl)
print(proc.time() - start)
initSHsweep <- data.frame(initSHsweepOutput, row.names=NULL)
```

```{r}
c(min(as.numeric(initSHsweep$gr)), max(as.numeric(initSHsweep$gr)))
max(as.numeric(initSHsweep$endTime))
```

```{r}
par(mfrow=c(2, 2), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    data <- initSHsweep$gr[initSHsweep$initSH==initSH]
    mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(initSHsweep$L), unique(initSHsweep$N)))
    mat <- mat[nrow(mat):1,]
    
    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (mat[[i, j]] <= 0) {
                mat[[i, j]] <- NA
            }
        }
    }
    
    colmax = max(as.numeric(initSHsweep$gr))
    colbreak = colmax/10
    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="lightgray", na.print=FALSE,
         breaks=seq(0, colmax, colbreak), col=viridis(10),
         key=NULL, fmt.cell='%.2f') 
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

## Two-symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001), "initST"=c(10, 0.5, 0.1))

time<-seq(1, 3000, 0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

twoSymbsOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(inputDF[i, "L"], inputDF[i, "L"], 0), N=c(inputDF[i, "N"], inputDF[i, "N"], 0), X=c(0, 0, 0))
    modifiedPars <- pars
    modifiedPars$initS[1:2] <- c(inputDF[i, "initSH"], 1)*inputDF[i, "initSH"]/(inputDF[i, "initSH"] + 1)
   
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- (run$S.1[length(run$S.1)] + run$S.2[length(run$S.2)]) / run$H[length(run$H)]
    finalST <- run$S.1[length(run$S.1)]/run$S.2[length(run$S.2)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS1 <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    changeS2 <- ifelse(abs(run$dS.Sdt.2[length(run$dS.Sdt.2)] - run$dS.Sdt.2[length(run$dS.Sdt.2)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "initST"=inputDF[i, "initST"], 
         "gr"=gr, "finalSH"=finalSH, "finalST"=finalST,
         "changeH"=changeH, "changeS1"=changeS1, "changeS2"=changeS2)
}

stopCluster(cl)
print(proc.time() - start)
twoSymbs <- data.frame(twoSymbsOutput, row.names=NULL)
```

### All simultions equilibrate

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

### Host growth rate

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        data <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]

        colmax = max(as.numeric(twoSymbs$gr))
        colbreak = colmax/10
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="lightgray", na.print=FALSE,
             breaks=seq(0, colmax, colbreak), col=viridis(10),
             key=NULL, fmt.cell='%.2f') 
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

### Sensitive:tolerant symbiont ratio

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        growth <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        data <- twoSymbs$finalST[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
    
        growthmat <- matrix(as.numeric(growth), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        growthmat <- growthmat[nrow(growthmat):1,]
        mat <- matrix(log10(as.numeric(data)), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]
    
        for (i in 1:nrow(mat)) {
            for (j in 1:ncol(mat)) {
                if (is.na(growthmat[[i, j]]) || growthmat[[i, j]] < 0) {
                    mat[[i, j]] <- NA
                }
            }
        }
    
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="gray",
         breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000), col=brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"),
         key=NULL)
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c("-1000 to -100", "-100 to -10", "-10 to -1", "-1 to 0", "0 to 1", "1 to 10", "10 to 100", "100 to 1000", "gr <= 0"), 
       fill=c(brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"), "gray"),
      title="log10 S:T ratio", cex=1.33, ncol=2)
```

# What happens with increased food? (X = 2e-7)


## One symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001))

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

initSHsweepOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    run <- coRal::run_coral_ss(env=list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "X"=2e-7), 
                               pars=replace(coRal::def_pars(), "initS", inputDF[i, "initSH"]))
    gr <- run$H$dH.Hdt[length(run$H$dH.Hdt)]
    finalSH <- run$S$S[length(run$S$S)] / run$H$H[length(run$H$H)]
    endTime <- (length(run$H$H) - 1)*run$dt
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "gr"=gr, "finalSH"=finalSH, "endTime"=endTime)
}

stopCluster(cl)
print(proc.time() - start)
initSHsweep <- data.frame(initSHsweepOutput, row.names=NULL)
```

```{r}
c(min(as.numeric(initSHsweep$gr)), max(as.numeric(initSHsweep$gr)))
max(as.numeric(initSHsweep$endTime))
```

```{r}
par(mfrow=c(2, 2), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    data <- initSHsweep$gr[initSHsweep$initSH==initSH]
    mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(initSHsweep$L), unique(initSHsweep$N)))
    mat <- mat[nrow(mat):1,]
    
    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (mat[[i, j]] <= 0) {
                mat[[i, j]] <- NA
            }
        }
    }
    
    colmax = max(as.numeric(initSHsweep$gr))
    colbreak = colmax/10
    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="lightgray", na.print=FALSE,
         breaks=seq(0, colmax, colbreak), col=viridis(10),
         key=NULL, fmt.cell='%.2f') 
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

## Two-symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001), "initST"=c(10, 0.5, 0.1))

time<-seq(1, 4000, 0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

twoSymbsOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(inputDF[i, "L"], inputDF[i, "L"], 0), N=c(inputDF[i, "N"], inputDF[i, "N"], 0), X=c(2e-7, 2e-7, 0))
    modifiedPars <- pars
    modifiedPars$initS[1:2] <- c(inputDF[i, "initSH"], 1)*inputDF[i, "initSH"]/(inputDF[i, "initSH"] + 1)
    
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- (run$S.1[length(run$S.1)] + run$S.2[length(run$S.2)]) / run$H[length(run$H)]
    finalST <- run$S.1[length(run$S.1)]/run$S.2[length(run$S.2)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS1 <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    changeS2 <- ifelse(abs(run$dS.Sdt.2[length(run$dS.Sdt.2)] - run$dS.Sdt.2[length(run$dS.Sdt.2)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "initST"=inputDF[i, "initST"], 
         "gr"=gr, "finalSH"=finalSH, "finalST"=finalST,
         "changeH"=changeH, "changeS1"=changeS1, "changeS2"=changeS2)
}

stopCluster(cl)
print(proc.time() - start)
twoSymbs <- data.frame(twoSymbsOutput, row.names=NULL)
```

### Some simulations failed to equilibrate

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

### Host growth rate

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        data <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]

        colmax = max(as.numeric(twoSymbs$gr))
        colbreak = colmax/10
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="lightgray", na.print=FALSE,
             breaks=seq(0, colmax, colbreak), col=viridis(10),
             key=NULL, fmt.cell='%.2f') 
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

### Sensitive:tolerant symbiont ratio

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        growth <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        data <- twoSymbs$finalST[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
    
        growthmat <- matrix(as.numeric(growth), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        growthmat <- growthmat[nrow(growthmat):1,]
        mat <- matrix(log10(as.numeric(data)), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]
    
        for (i in 1:nrow(mat)) {
            for (j in 1:ncol(mat)) {
                if (is.na(growthmat[[i, j]]) || growthmat[[i, j]] < 0) {
                    mat[[i, j]] <- NA
                }
            }
        }
    
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="gray",
         breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000), col=brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"),
         key=NULL)
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c("-1000 to -100", "-100 to -10", "-10 to -1", "-1 to 0", "0 to 1", "1 to 10", "10 to 100", "100 to 1000", "gr <= 0"), 
       fill=c(brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"), "gray"),
      title="log10 S:T ratio", cex=1.33, ncol=2)
```

# High food case? (X = 4e-7)


## One symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001))

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

initSHsweepOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    run <- coRal::run_coral_ss(env=list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "X"=4e-7), 
                               pars=replace(coRal::def_pars(), "initS", inputDF[i, "initSH"]))
    gr <- run$H$dH.Hdt[length(run$H$dH.Hdt)]
    finalSH <- run$S$S[length(run$S$S)] / run$H$H[length(run$H$H)]
    endTime <- (length(run$H$H) - 1)*run$dt
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "gr"=gr, "finalSH"=finalSH, "endTime"=endTime)
}

stopCluster(cl)
print(proc.time() - start)
initSHsweep <- data.frame(initSHsweepOutput, row.names=NULL)
```

```{r}
c(min(as.numeric(initSHsweep$gr)), max(as.numeric(initSHsweep$gr)))
c(max(as.numeric(initSHsweep$endTime)))
```

```{r}
par(mfrow=c(2, 2), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    data <- initSHsweep$gr[initSHsweep$initSH==initSH]
    mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(initSHsweep$L), unique(initSHsweep$N)))
    mat <- mat[nrow(mat):1,]
    
    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (mat[[i, j]] <= 0) {
                mat[[i, j]] <- NA
            }
        }
    }
    
    colmax = max(as.numeric(initSHsweep$gr))
    colbreak = colmax/10
    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="lightgray", na.print=FALSE,
         breaks=seq(0, colmax, colbreak), col=viridis(10),
         key=NULL, fmt.cell='%.2f') 
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

## Two-symbiont case

```{r}
inputDF <- expand.grid("L"=seq(0, 50, 5), "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001), "initST"=c(10, 0.5, 0.1))

time<-seq(1, 3000, 0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

twoSymbsOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(inputDF[i, "L"], inputDF[i, "L"], 0), N=c(inputDF[i, "N"], inputDF[i, "N"], 0), X=c(4e-7, 4e-7, 0))
    modifiedPars <- pars
    modifiedPars$initS[1:2] <- c(inputDF[i, "initSH"], 1)*inputDF[i, "initSH"]/(inputDF[i, "initSH"] + 1)
    
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- (run$S.1[length(run$S.1)] + run$S.2[length(run$S.2)]) / run$H[length(run$H)]
    finalST <- run$S.1[length(run$S.1)]/run$S.2[length(run$S.2)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS1 <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    changeS2 <- ifelse(abs(run$dS.Sdt.2[length(run$dS.Sdt.2)] - run$dS.Sdt.2[length(run$dS.Sdt.2)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "initST"=inputDF[i, "initST"], 
         "gr"=gr, "finalSH"=finalSH, "finalST"=finalST,
         "changeH"=changeH, "changeS1"=changeS1, "changeS2"=changeS2)
}

stopCluster(cl)
print(proc.time() - start)
twoSymbs <- data.frame(twoSymbsOutput, row.names=NULL)
```

### All simulations equilibrated by the end

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

### Host growth rate

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        data <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]

        colmax = max(as.numeric(twoSymbs$gr))
        colbreak = colmax/10
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="lightgray", na.print=FALSE,
             breaks=seq(0, colmax, colbreak), col=viridis(10),
             key=NULL, fmt.cell='%.2f') 
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

### Sensitive:tolerant symbiont ratio

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        growth <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        data <- twoSymbs$finalST[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
    
        growthmat <- matrix(as.numeric(growth), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        growthmat <- growthmat[nrow(growthmat):1,]
        mat <- matrix(log10(as.numeric(data)), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]
    
        for (i in 1:nrow(mat)) {
            for (j in 1:ncol(mat)) {
                if (is.na(growthmat[[i, j]]) || growthmat[[i, j]] < 0) {
                    mat[[i, j]] <- NA
                }
            }
        }
    
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="gray",
         breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000), col=brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"),
         key=NULL)
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c("-1000 to -100", "-100 to -10", "-10 to -1", "-1 to 0", "0 to 1", "1 to 10", "10 to 100", "100 to 1000", "gr <= 0"), 
       fill=c(brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"), "gray"),
      title="log10 S:T ratio", cex=1.33, ncol=2)
```

# No food dynamics: special case
Bleaching avoided by having tolerant symbiont, yet sensitive symbiont dominates

```{r}
plot_2sh <- function(run) with(run, {
  plot(time, env.L, type="l", col=scales::alpha("gold", 0.5), axes=F, ylim=c(0, 50), ylab="", xlab="")
  axis(side=4)
  par(new=T)
  plot(time, (S.1+S.2)/H, ylim=c(0, max((S.1+S.2)/H*1.1)), type="l", ylab="S/H", xlab="Days")
  lines(S.1/H ~ time, col="blue")
  lines(S.2/H ~ time, col="red")
  legend("topright", legend=c("sensitive", "tolerant"), col=c("blue", "red"), lty=1, bty="n")
})
```

```{r}
##### Define simulation environment (seasonal fluctuation in light)
time <- seq(1,3000,0.1)
env <- init_env(time=time, X=c(0,0,0), N=c(5e-7,5e-7,0), L=c(15,15,0))

pars <- def_pars(nsym=2)

# Make symbiont 2 have lower jCPm and higher kROS (i.e., tolerant symbiont)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
pars$initS[1:2] <- 0.5

# Run simulations with sensitive or tolerant symbiont
run <- run_coral(time=time, env=env,pars=pars)

par(mfrow=c(2, 1))
plot_2sh(run)
plot(run$dH.Hdt)
```

```{r}
##### Define simulation environment (seasonal fluctuation in light)
time <- seq(1,3000,0.1)
env <- init_env(time=time, X=c(0,0,0), N=c(5e-7,5e-7,0), L=c(15,15,0))

pars <- def_pars(nsym=1)

# Run simulations with sensitive or tolerant symbiont
run <- run_coral(time=time, env=env, pars=pars)

par(mfrow=c(2, 1))
plot(time, run$S/run$H, ylim=c(0, 1))
plot(time, run$dH.Hdt)
```

```{r}
run$dH.Hdt[length(run$dH.Hdt)]
```

# High light followed by lower light

```{r}
# produces environment to go with a time=seq(tstart, tend, dt)
# light starts at value given by low
# at time=highstart, light becomes value given by high
# after highlength time, light returns to low
# nitrogen (N) and prey (X) are constant
lowhighlow <- function(tstart, tend, dt, highstart, highlength, high, low, N, X) {
    list(
        L=c(rep(low, (highstart-tstart)/dt), 
      rep(high, (highlength)/dt),
     rep(low, tend/dt - (highstart + highlength)/dt+1)),
        N=rep(N, (tend-tstart)/dt+1),
        X=rep(X, (tend-tstart)/dt+1))
}
```

```{r}
##### Define simulation environment (seasonal fluctuation in light)
time <- seq(1, 4000,0.1)

pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

par(mfrow=c(2, 3), pty="s", mai=c(0.1,0.3,0.1,0.3))

for (lowL in c(10, 15, 20, 25, 30, 35)) {
    env <- lowhighlow(1, 4000, 0.1, 2000, 30, 50, lowL, 1e-6, 0)

    run <- run_coral(time=time, env=env, pars=pars)
    plot_2sh(run)
}
```

```{r}
inputDF <- expand.grid("Lstress"=c(30, 50), "Lnormal"=seq(0, 30, 5), "stressTime"=c(7, 28),
                       "N"=seq(0, 4e-6, 5e-7), "initSH" = c(1, 0.0001), "initST"=c(10, 0.5, 0.1))

time<-seq(1, 6000, 0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

twoSymbsOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- lowhighlow(1, 6000, 0.1, 3000, inputDF[i, "stressTime"], inputDF[i, "Lstress"], inputDF[i, "Lnormal"], inputDF[i, "N"], 0)
    modifiedPars <- pars
    modifiedPars$initS[1:2] <- c(inputDF[i, "initSH"], 1)*inputDF[i, "initSH"]/(inputDF[i, "initSH"] + 1)
    
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- (run$S.1[length(run$S.1)] + run$S.2[length(run$S.2)]) / run$H[length(run$H)]
    finalST <- run$S.1[length(run$S.1)]/run$S.2[length(run$S.2)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS1 <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    changeS2 <- ifelse(abs(run$dS.Sdt.2[length(run$dS.Sdt.2)] - run$dS.Sdt.2[length(run$dS.Sdt.2)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], "initST"=inputDF[i, "initST"], 
         "gr"=gr, "finalSH"=finalSH, "finalST"=finalST,
         "changeH"=changeH, "changeS1"=changeS1, "changeS2"=changeS2)
}

stopCluster(cl)
print(proc.time() - start)
twoSymbs <- data.frame(twoSymbsOutput, row.names=NULL)
```

### All simulations equilibrated by the end

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

### Host growth rate

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        data <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]

        colmax = max(as.numeric(twoSymbs$gr))
        colbreak = colmax/10
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="lightgray", na.print=FALSE,
             breaks=seq(0, colmax, colbreak), col=viridis(10),
             key=NULL, fmt.cell='%.2f') 
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

### Sensitive:tolerant symbiont ratio

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

```{r}
par(mfrow=c(3, 3), pty="s", mai=c(0.4,0,0.2,0))

for (initSH in c(1, 0.0001)) {
    for (initST in c(10, 0.5, 0.1)) {
        growth <- twoSymbs$gr[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
        data <- twoSymbs$finalST[(twoSymbs$initSH==initSH)&(twoSymbs$initST==initST)]
    
        growthmat <- matrix(as.numeric(growth), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        growthmat <- growthmat[nrow(growthmat):1,]
        mat <- matrix(log10(as.numeric(data)), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
        mat <- mat[nrow(mat):1,]
    
        for (i in 1:nrow(mat)) {
            for (j in 1:ncol(mat)) {
                if (is.na(growthmat[[i, j]]) || growthmat[[i, j]] < 0) {
                    mat[[i, j]] <- NA
                }
            }
        }
    
        plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH, "& S:T =", initST), na.col="gray",
         breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000), col=brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"),
         key=NULL)
    }
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c("-1000 to -100", "-100 to -10", "-10 to -1", "-1 to 0", "0 to 1", "1 to 10", "10 to 100", "100 to 1000", "gr <= 0"), 
       fill=c(brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"), "gray"),
      title="log10 S:T ratio", cex=1.33, ncol=2)
```
