---
title: "Investigating how tolerant symbiont parameters affect rescue"
author: "Ross Cunning and Alexandra Brown"
date: "5/6/2020"
output:
      html_document:
            code_fold: hide
---

```{r}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, fig.width=8, fig.height=8)

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")
library("factoextra")
library("e1071")
library("coda")
library("rstan")
options(mc.cores = 8)
library("bayesplot")
library("ggplot2")
library("gridExtra")
library("adegenet")
options(repr.plot.res=240)
```
## A function for detecting when the host growth rate changes sign

```{r, cache = TRUE}
detect_gr_change <- function(run) {
    prevGr <- run$dH.Hdt[1:length(run$dH.Hdt)-1]
    currGr <- run$dH.Hdt[2:length(run$dH.Hdt)]
    changelist <- ((run$time[2:length(run$time)] + run$time[1:length(run$time)-1])/2)[prevGr*currGr<= 0]
    if (length(changelist) > 0) {
          return(changelist[length(changelist)])
   }
   return(NA)
}
```

```{r, cache = TRUE}
# one-symbiont parameters
pars1 <- def_pars(nsym=1)
pars1$initS <- 1e-4

# run simulations for 3000 days
time<-seq(1, 3000, 0.1)

# draw sets of parameter values randomly
# hopefully this will speed things up compared to looking over a grid

draws = 10000; # number of sets of random parameter combinations to look over

search_params <- data.frame(
                            # Environmental parameters
                            "L" = runif(draws, 0, 40),       # Light, choose values between 0 and 40
                            "N" = runif(draws, 0, 4e-6),     # DIN, choose values between 0 and 4e-6
                            "X" = runif(draws, 0, 4e-7),     # Food, choose values between 0 and 4e-7
                            # Host parameter
                            "kCO2" = runif(draws, 10, 50),   # Host carbon concentrating, choose values between 10 and 50
                            # Tolerant symbiont parameters
                            "kNPQ" = runif(draws, 112, 224), # Non-photochemical quenching, choose values between 112 and 124
                            "astar" = runif(draws, 0.67, 1.34), # astar, choose values between 0.7 and 1.34     
                            "jSGm" = runif(draws, 0.15, 0.25), # Maximum growth rate, choose values between 0.15 and 0.25
                            "jCPm" = runif(draws, 1, 2.8), # Maximum photosynthetic rate, choose values between 1 and 2.8
                            "kROS" = runif(draws, 80, 250), # kROS, choose values between 80 and 250
                            "b" = runif(draws, 1, 5))   # b, choose values between 1 and 5

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# start the timer
start <- proc.time()


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    env <- coRal::init_env(time=time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    # simulate dynamics with just the sensitive symbiont
    run_1symb <- coRal::run_coral(time=time, env=env, pars=replace(pars1, "kCO2", search_params[i, "kCO2"]))

    # initialize rescue; will be TRUE if the tolerant symbiont rescued the sensitive
    rescue <- FALSE

    # initialize reason; will give the reason for lack of rescue if rescue does not occur
    # reason = "S_lives" -> host recovers with sensitive symbiont alone; does not need to be rescued by tolerant
    # reason = "T_dies" -> tolerant symbiont unable to rescue host
    # reason = "T_dominates" -> tolerant symbiont permits host recovery while sensitive does not, but tolerant dominates post-recovery
    # reason = "rescue" -> rescue occurred
    reason <- NA
    rescue_time <- NA

    # if the coral can achieve positive growth with just the sensitive symbiont, the sensitive symbiont doesn't need to be rescued
    # only investigate the two-symbiont case if host growth is negative or 0 at the end of the simulation
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] > 0) {
          reason <- "S_lives"
          rescue_time <- detect_gr_change(run_1symb)
    }

    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] <= 0) {

         # two-symbiont parameters
         pars2 <- coRal::def_pars(nsym=2)
         pars2$kCO2 <- search_params[i, "kCO2"]
         pars2$initS[1:2] <- c(0.5e-4, 0.5e-4)
         pars2$astar[2] <- search_params[i, "astar"]
         pars2$kNPQ[2] <- search_params[i, "kNPQ"]
         pars2$jSGm[2] <- search_params[i, "jSGm"]
         pars2$jCPm[2] <- search_params[i, "jCPm"]
         pars2$kROS[2] <- search_params[i, "kROS"]
         pars2$b[2] <- search_params[i, "b"]



        run_2symb <- coRal::run_coral(time=time, env=env, pars=pars2)

        # if the coral didn't achieve positive growth with both symbionts, then rescue definitely didn't happen
        # set reason to "T_dies" in case this is the case (we'll change it later if it isn't)
        reason <- "T_dies"
        rescue_time <- NA

        # if the tolerant symbiont rescues the sensitive symbiont, we want to record how long that takes to happen
        # if that doesn't happen, we'll record the time to rescue as NA


        # only further investigate the case where host growth is positive at the end of the simulation

        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] > 0) {

            # the sensitive symbiont (S1) has been rescued if it now has higher biomass than the tolerant symbiont (S2)
            # set reason to "T_dominates" for now because this is what must have happened if rescue did not occur
            reason <- "T_dominates"
            rescue_time <- detect_gr_change(run_2symb)

            if (run_2symb$S.1[length(run_2symb$S.1)] > run_2symb$S.2[length(run_2symb$S.2)]) {

                rescue <- TRUE
                reason <- "rescue"

                rescue_time <- detect_gr_change(run_2symb)
            }
        }
    }

    # return the parameters and whether rescue was successful or not
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"],
    "X"=search_params[i, "X"], "kCO2"=search_params[i, "kCO2"],
    "astar"=search_params[i, "astar"], "kNPQ"=search_params[i, "kNPQ"],
    "jSGm"=search_params[i, "jSGm"], "jCPm"=search_params[i, "jCPm"],
    "kROS"=search_params[i, "kROS"], "b"=search_params[i, "b"],
    "rescue"=rescue, "reason"=reason, "rescue_time"=rescue_time)
}

stopCluster(cl) # stop the cluster

# print time this took
print("Simulation took")
print(proc.time() - start)

# store results in dataframe
rescue_tol_param <- data.frame(results, row.names=NULL)

```

# Plots of outcomes

```{r}
# Thin points so all outcomes can be plotted together

points_S_lives = rescue_tol_param[(rescue_tol_param$reason == "S_lives")  & (rescue_tol_param$rescue_time <= 100),];
#points_rescue = rescue_tol_param[rescue_tol_param$reason == "rescue",][1:min(500, sum(rescue_tol_param$reason == "rescue")),];
#points_T_dies = rescue_tol_param[rescue_tol_param$reason == "T_dies",][1:min(500, sum(rescue_tol_param$reason == "T_dies")),];
points_T_dominates = rescue_tol_param[(rescue_tol_param$reason == "T_dominates") & (rescue_tol_param$rescue_time <= 100),];

points_rescue = rescue_tol_param[(rescue_tol_param$reason == "rescue") & (rescue_tol_param$rescue_time <= 100),];

points_T_dies = rescue_tol_param[(rescue_tol_param$reason == "T_dies") | ((rescue_tol_param$reason != "T_dies") & (rescue_tol_param$rescue_time > 100)),];


plot_count_S_lives = round(nrow(points_S_lives)/nrow(rescue_tol_param) * 2000, 0);
plot_count_T_dominates = round(nrow(points_T_dominates)/nrow(rescue_tol_param) * 2000, 0);
plot_count_rescue = round(nrow(points_rescue)/nrow(rescue_tol_param) * 2000, 0);
plot_count_T_dies = round(nrow(points_T_dies)/nrow(rescue_tol_param) * 2000,0);

points_S_lives = points_S_lives[1:plot_count_S_lives,];
points_T_dominates = points_T_dominates[1:plot_count_T_dominates,];
points_rescue = points_rescue[1:plot_count_rescue,];
points_T_dies = points_T_dies[1:plot_count_T_dies,];

```

## Environmental & host parameters

```{r}
par(mfrow=c(3, 3), pty="s")

plot(points_S_lives$L, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="Nitrogen vs Light", xlab="L", ylab="N", xlim=c(0, 40), ylim=c(0, 4e-6))
points(points_T_dies$L, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$L, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$L, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$L, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="Food vs Light", xlab="L", ylab="X", xlim=c(0, 40), ylim=c(0, 4e-7))
points(points_T_dies$L, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$L, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$L, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$L, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
      main="kCO2 vs Light", xlab="L", ylab="kCO2", xlim=c(0, 40), ylim=c(10, 50))
points(points_T_dies$L, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$L, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$L, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$N, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
      main="Food vs Nitrogen", xlab="N", ylab="X", xlim=c(0, 4e-6), ylim=c(0, 4e-7))
points(points_T_dies$N, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$N, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$N, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$N, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
      main="kCO2 vs Nitrogen", xlab="N", ylab="kCO2", xlim=c(0, 4e-6), ylim=c(10, 50))
points(points_T_dies$N, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$N, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$N, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$X, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
      main="kCO2 vs Food", xlab="X", ylab="kCO2", xlim=c(0, 4e-7), ylim=c(10, 50))
points(points_T_dies$X, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$X, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$X, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ S", "Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("red", "black", "green", "blue"), pch=19)

```

## Light vs. tolerant parameters

```{r}
par(mfrow=c(3,3), pty="s")

plot(points_S_lives$astar, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="Light vs astar", xlab="astar", ylab="L", xlim=c(0.67, 1.34), ylim=c(0, 40))
points(points_T_dies$astar, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$astar, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kNPQ, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
    main="Light vs kNPQ", xlab="kNPQ", ylab="L", xlim=c(112, 224), ylim=c(0, 40))
points(points_T_dies$kNPQ, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kNPQ, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jSGm, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Light vs jSGm", xlab="jSGm", ylab="L", xlim=c(0.15, 0.25), ylim=c(0, 40))
points(points_T_dies$jSGm, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jSGm, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jCPm, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Light vs jCPm", xlab="jCPm", ylab="L", xlim=c(1, 2.8), ylim=c(0, 40))
points(points_T_dies$jCPm, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jCPm, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kROS, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Light vs kROS", xlab="kROS", ylab="L", xlim=c(80, 250), ylim=c(0, 40))
points(points_T_dies$kROS, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kROS, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kROS, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$b, points_S_lives$L, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Light vs b", xlab="b", ylab="L", xlim=c(1, 5), ylim=c(0, 40))
points(points_T_dies$b, points_T_dies$L, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$b, points_T_dominates$L, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$b, points_rescue$L, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ S", "Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("red", "black", "green", "blue"), pch=19)

```

## Nitrogen vs. tolerant parameters

```{r}
par(mfrow=c(3,3), pty="s")

plot(points_S_lives$astar, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="Nitrogen vs astar", xlab="astar", ylab="N", xlim=c(0.67, 1.34), ylim=c(0, 4e-6))
points(points_T_dies$astar, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$astar, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kNPQ, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
    main="Nitrogen vs kNPQ", xlab="kNPQ", ylab="N", xlim=c(112, 224), ylim=c(0, 4e-6))
points(points_T_dies$kNPQ, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kNPQ, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jSGm, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Nitrogen vs jSGm", xlab="jSGm", ylab="N", xlim=c(0.15, 0.25), ylim=c(0, 4e-6))
points(points_T_dies$jSGm, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jSGm, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jCPm, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Nitrogen vs jCPm", xlab="jCPm", ylab="N", xlim=c(1, 2.8), ylim=c(0, 4e-6))
points(points_T_dies$jCPm, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jCPm, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kROS, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Nitrogen vs kROS", xlab="kROS", ylab="N", xlim=c(80, 250), ylim=c(0, 4e-6))
points(points_T_dies$kROS, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kROS, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kROS, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$b, points_S_lives$N, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Nitrogen vs b", xlab="b", ylab="N", xlim=c(1, 5), ylim=c(0, 4e-6))
points(points_T_dies$b, points_T_dies$N, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$b, points_T_dominates$N, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$b, points_rescue$N, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ S", "Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("red", "black", "green", "blue"), pch=19)
```

## Food vs. tolerant parameters

```{r}
par(mfrow=c(3,3), pty="s")

plot(points_S_lives$astar, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="Food vs astar", xlab="astar", ylab="X", xlim=c(0.67, 1.34), ylim=c(0, 4e-7))
points(points_T_dies$astar, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$astar, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kNPQ, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
    main="Food vs kNPQ", xlab="kNPQ", ylab="X", xlim=c(112, 224), ylim=c(0, 4e-7))
points(points_T_dies$kNPQ, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kNPQ, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jSGm, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Food vs jSGm", xlab="jSGm", ylab="X", xlim=c(0.15, 0.25), ylim=c(0, 4e-7))
points(points_T_dies$jSGm, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jSGm, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jCPm, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Food vs jCPm", xlab="jCPm", ylab="X", xlim=c(1, 2.8), ylim=c(0, 4e-7))
points(points_T_dies$jCPm, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jCPm, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kROS, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Food vs kROS", xlab="kROS", ylab="X", xlim=c(80, 250), ylim=c(0, 4e-7))
points(points_T_dies$kROS, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kROS, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kROS, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$b, points_S_lives$X, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="Food vs b", xlab="b", ylab="X", xlim=c(1, 5), ylim=c(0, 4e-7))
points(points_T_dies$b, points_T_dies$X, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$b, points_T_dominates$X, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$b, points_rescue$X, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ S", "Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("red", "black", "green", "blue"), pch=19)
```

## kCO2 vs. tolerant parameters

```{r}
par(mfrow=c(3,3), pty="s")

plot(points_S_lives$astar, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
     main="kCO2 vs astar", xlab="astar", ylab="kCO2", xlim=c(0.67, 1.34), ylim=c(10, 50))
points(points_T_dies$astar, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$astar, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kNPQ, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
    main="kCO2 vs kNPQ", xlab="kNPQ", ylab="kCO2", xlim=c(112, 224), ylim=c(10, 50))
points(points_T_dies$kNPQ, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kNPQ, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jSGm, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="kCO2 vs jSGm", xlab="jSGm", ylab="kCO2", xlim=c(0.15, 0.25), ylim=c(10, 50))
points(points_T_dies$jSGm, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jSGm, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$jCPm, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="kCO2 vs jCPm", xlab="jCPm", ylab="kCO2", xlim=c(1, 2.8), ylim=c(10, 50))
points(points_T_dies$jCPm, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$jCPm, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$kROS, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="kCO2 vs kROS", xlab="kROS", ylab="kCO2", xlim=c(80, 250), ylim=c(10, 50))
points(points_T_dies$kROS, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$kROS, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kROS, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_S_lives$b, points_S_lives$kCO2, pch=19, col=rgb(1, 0, 0, alpha=0.3),
   main="kCO2 vs b", xlab="b", ylab="kCO2", xlim=c(1, 5), ylim=c(10, 50))
points(points_T_dies$b, points_T_dies$kCO2, pch=19, col=rgb(0, 1, 0, alpha=0.3))
points(points_T_dominates$b, points_T_dominates$kCO2, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$b, points_rescue$kCO2, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ S", "Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("red", "black", "green", "blue"), pch=19)
```

## Tolerant parameters vs. each other
("Recovers with S" case not shown, because recovery with sensitive symbiont does not depend on tolerant parameters)

```{r}
par(mfrow=c(3, 3), pty="s")

plot(points_T_dies$astar, points_T_dies$kNPQ, pch=19, col=rgb(0, 1, 0, alpha=0.3),
     main="kNPQ vs astar", xlab="astar", ylab="kNPQ", xlim=c(0.67, 1.34), ylim=c(112, 224))
points(points_T_dominates$astar, points_T_dominates$kNPQ, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$kNPQ, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$astar, points_T_dies$jSGm, pch=19, col=rgb(0, 1, 0, alpha=0.3),
     main="jSGm vs astar", xlab="astar", ylab="jSGm", xlim=c(0.67, 1.34), ylim=c(0.15, 0.25))
points(points_T_dominates$astar, points_T_dominates$jSGm, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$jSGm, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$astar, points_T_dies$jCPm, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="jCPm vs astar", xlab="astar", ylab="jCPm", xlim=c(0.67, 1.34), ylim=c(1, 2.8))
points(points_T_dominates$astar, points_T_dominates$jCPm, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$jCPm, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$astar, points_T_dies$kROS, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="kROS vs astar", xlab="astar", ylab="kROS", xlim=c(0.67, 1.34), ylim=c(80, 250))
points(points_T_dominates$astar, points_T_dominates$kROS, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$kROS, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$astar, points_T_dies$b, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="b vs astar", xlab="astar", ylab="b", xlim=c(0.67, 1.34), ylim=c(1, 5))
points(points_T_dominates$astar, points_T_dominates$b, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$astar, points_rescue$b, pch=19, col=rgb(0, 0, 1, alpha=0.3))


plot(points_T_dies$kNPQ, points_T_dies$jSGm, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="jSGm vs kNPQ", xlab="kNPQ", ylab="jSGm", xlim=c(112, 224), ylim=c(0.15, 0.25))
points(points_T_dominates$kNPQ, points_T_dominates$jSGm, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$jSGm, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$kNPQ, points_T_dies$jCPm, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="jCPm vs kNPQ", xlab="kNPQ", ylab="jCPm", xlim=c(112, 224), ylim=c(1, 2.8))
points(points_T_dominates$kNPQ, points_T_dominates$jCPm, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$jCPm, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$kNPQ, points_T_dies$kROS, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="kROS vs kNPQ", xlab="kNPQ", ylab="kROS", xlim=c(112, 224), ylim=c(80, 250))
points(points_T_dominates$kNPQ, points_T_dominates$kROS, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$kROS, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$kNPQ, points_T_dies$b, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="b vs kNPQ", xlab="kNPQ", ylab="b", xlim=c(112, 224), ylim=c(1, 5))
points(points_T_dominates$kNPQ, points_T_dominates$b, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kNPQ, points_rescue$b, pch=19, col=rgb(0, 0, 1, alpha=0.3))


plot(points_T_dies$jSGm, points_T_dies$jCPm, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="jCPm vs jSGm", xlab="jSGm", ylab="jCPm", xlim=c(0.15, 0.25), ylim=c(1, 2.8))
points(points_T_dominates$jSGm, points_T_dominates$jCPm, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$jCPm, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$jSGm, points_T_dies$kROS, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="kROS vs jSGm", xlab="jSGm", ylab="kROS", xlim=c(0.15, 0.25), ylim=c(80, 250))
points(points_T_dominates$jSGm, points_T_dominates$kROS, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$kROS, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$jSGm, points_T_dies$b, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="b vs jSGm", xlab="jSGm", ylab="b", xlim=c(0.15, 0.25), ylim=c(1, 5))
points(points_T_dominates$jSGm, points_T_dominates$b, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jSGm, points_rescue$b, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$jCPm, points_T_dies$kROS, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="kROS vs jCPm", xlab="jCPm", ylab="kROS", xlim=c(1, 2.8), ylim=c(80, 250))
points(points_T_dominates$jCPm, points_T_dominates$kROS, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$kROS, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$jCPm, points_T_dies$b, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="b vs jCPm", xlab="jCPm", ylab="b", xlim=c(1, 2.8), ylim=c(1, 5))
points(points_T_dominates$jCPm, points_T_dominates$b, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$jCPm, points_rescue$b, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot(points_T_dies$kROS, points_T_dies$b, pch=19, col=rgb(0, 1, 0, alpha=0.3),
      main="b vs kROS", xlab="kROS", ylab="b", xlim=c(80, 250), ylim=c(1, 5))
points(points_T_dominates$kROS, points_T_dominates$b, pch=19, col=rgb(0, 0, 0, alpha=0.3))
points(points_rescue$kROS, points_rescue$b, pch=19, col=rgb(0, 0, 1, alpha=0.3))

plot.new()
legend("topright", c("Recovers w/ T", "No recovery", "Recovers w/ S in \npresence of T"), col=c("black", "green", "blue"), pch=19)

```

```{r, cache=TRUE}
# results_stan <- lapply(rescue_tol_param$reason,
#       function(r) {
#             if(r=="S_lives") {
#                   1
#             } else if (r=="rescue") {
#                   2
#             } else if (r=="T_dies") {
#                   3
#             } else if (r=="T_dominates") {
#                   4
#             } else {
#                   NA
#             }})
#
# results_stan <- as.numeric(results_stan)
#
# predictors_stan <- with(rescue_tol_param, {data.frame(L=as.numeric(L), N=as.numeric(N), X=as.numeric(X), kCO2=as.numeric(kCO2),
#       astar=as.numeric(astar), kNPQ=as.numeric(kNPQ), jSGm=as.numeric(jSGm), jCPm=as.numeric(jCPm),
#       kROS=as.numeric(kROS), b=as.numeric(b))})
#
# predictors_stan <- as.matrix(predictors_stan)
#
# ml_stan <- stan("multilogit.stan", data=list("K"=4, # number of outcomes (S_lives = 1, Rescue =2, T_dies=3, T_dominates=4)
#                                   "N"=length(results_stan), # number of data points
#                                   "D"=ncol(predictors_stan), # number of predictors (variables we changed)
#                                   "y"=results_stan, # vector of observed outcomes
#                                   "x"=predictors_stan), # matrix of observations and predictors
#                       chains=8, iter=2000, cores=8)
```

```{r}
# print(ml_stan)
#
# slives_stan <- as.matrix(ml_stan, pars = list("beta[1,1]", "beta[2,1]", "beta[3,1]", "beta[4,1]", "beta[5,1]",
#       "beta[6,1]", "beta[7,1]", "beta[8,1]", "beta[9,1]", "beta[10,1]"))
#
# rescue_stan <- as.matrix(ml_stan, pars = list("beta[1,2]", "beta[2,2]", "beta[3,2]", "beta[4,2]", "beta[5,2]",
#       "beta[6,2]", "beta[7,2]", "beta[8,2]", "beta[9,2]", "beta[10,2]"))  
#
# tdies_stan <- as.matrix(ml_stan, pars = list("beta[1,3]", "beta[2,3]", "beta[3,3]", "beta[4,3]", "beta[5,3]",
#       "beta[6,3]", "beta[7,3]", "beta[8,3]", "beta[9,3]", "beta[10,3]"))
#
# tdominates_stan <- as.matrix(ml_stan, pars = list("beta[1,4]", "beta[2,4]", "beta[3,4]", "beta[4,4]", "beta[5,4]",
#       "beta[6,4]", "beta[7,4]", "beta[8,4]", "beta[9,4]", "beta[10,4]"))   
#
#
# p1 <- mcmc_intervals(slives_stan) + scale_y_discrete(labels = c("L", "N", "X",
#       "kCO2", "astar", "kNPQ", "jSGm", "jCPm", "kROS", "b")) +
#       ggtitle("Sensitive symb. allows host survival") + xlab("Slope of contribution to probability (softmax scale)")
#
# p2 <- mcmc_intervals(rescue_stan) + scale_y_discrete(labels = c("L", "N", "X",
#       "kCO2", "astar", "kNPQ", "jSGm", "jCPm", "kROS", "b")) +
#       ggtitle("RESCUE") + xlab("Slope of contribution to probability (softmax scale)")
#
# p3 <- mcmc_intervals(tdies_stan) + scale_y_discrete(labels = c("L", "N", "X",
#       "kCO2", "astar", "kNPQ", "jSGm", "jCPm", "kROS", "b")) +
#       ggtitle("Neither symb. allows host survival") + xlab("Slope of contribution to probability (softmax scale)")
#
# p4 <- mcmc_intervals(tdominates_stan) + scale_y_discrete(labels = c("L", "N", "X",
#       "kCO2", "astar", "kNPQ", "jSGm", "jCPm", "kROS", "b")) +
#       ggtitle("Tolerant symb. alone allows survival; takes over") + xlab("Slope of contribution to probability (softmax scale)")
#
# grid.arrange(p1, p2, p3, p4, nrow=2)
```

# What environmental, host, and tolerant symbiont traits affect time to recovery?
For the case where S. lives but only when T. is also present (the "rescue" case)

```{r, cache=TRUE, results=FALSE, message=FALSE}

dapc_grp <- unlist(rescue_tol_param$reason)

for (i in 1:nrow(rescue_tol_param)) {
      if ((is.na(rescue_tol_param[i, "rescue_time"]) == FALSE) & (rescue_tol_param[i, "rescue_time"] > 100)) {
            dapc_grp[[i]] <- "T_dies"
      }
}

dapc_grp <- as.factor(dapc_grp)

dapc_x <- rescue_tol_param
dapc_x$reason <- NULL
dapc_x$rescue <- NULL
dapc_x$rescue_time <- NULL
dapc_x[] <- lapply(dapc_x, as.numeric)

library("plyr")
data_2symb <- dapc_x
data_2symb$outcome <- dapc_grp
data_2symb$outcome <- revalue(data_2symb$outcome, c("S_lives"="recovers_S", "T_dominates"="recovers_T", "T_dies"="no_recovery", "rescue"="recovers_rescue"))
save(data_2symb, file="data_2symb.Rda")
#
# my_dapc <- dapc(dapc_x, dapc_grp)

```


```{r}

# print(my_dapc)
#
# summary(my_dapc)
#
# scatter(my_dapc)

#stan_data <- rescue_tol_param[rescue_tol_param$rescue==TRUE,];

# recovery_time_model <- stan("rescue_time.stan",
#       data=list("P"=nrow(stan_data),
#                 "y"=as.numeric(stan_data$rescue_time),
#                 "L"=as.numeric(stan_data$L),
#                 "N"=as.numeric(stan_data$N),
#                 "X"=as.numeric(stan_data$X),
#                 "kCO2"=as.numeric(stan_data$kCO2),
#                 "kNPQ"=as.numeric(stan_data$kNPQ),
#                 "astar"=as.numeric(stan_data$astar),
#                 "jSGm"=as.numeric(stan_data$jSGm),
#                 "jCPm"=as.numeric(stan_data$jCPm),
#                 "kROS"=as.numeric(stan_data$kROS),
#                 "b"=as.numeric(stan_data$b)),
#                 chains=4, iter=2000, cores=4, refresh=100)
```
