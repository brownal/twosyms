---
title: "Investigating a special case of shuffling in a constant environment"
author: "Ross Cunning and Alexandra Brown"
date: "4/8/2020"
output: html_document
---

```{r}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, fig.width=8, fig.height=8)

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")

options(repr.plot.res=240)
```
# No food dynamics: special case
Recovery possible by having tolerant symbiont, yet sensitive symbiont dominates

```{r}
plot_2sh <- function(run) with(run, {
  plot(time, env.L, type="l", col=scales::alpha("gold", 0.5), axes=F, ylim=c(0, 50), ylab="", xlab="")
  axis(side=4)
  par(new=T)
  plot(time, (S.1+S.2)/H, ylim=c(0, max((S.1+S.2)/H*1.1)), type="l", ylab="S/H", xlab="Days")
  lines(S.1/H ~ time, col="blue")
  lines(S.2/H ~ time, col="red")
  legend("topright", legend=c("sensitive", "tolerant"), col=c("blue", "red"), lty=1, bty="n")
})
```

```{r}
##### Define simulation environment
time <- seq(1,3000,0.1)
env <- init_env(time=time, X=c(0,0,0), N=c(5e-7,5e-7,0), L=c(15,15,0))

pars <- def_pars(nsym=2)

# Make symbiont 2 have lower jCPm and higher kROS (i.e., tolerant symbiont)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15
pars$initS[1:2] <- 0.5e-4

# Run simulations with sensitive or tolerant symbiont
run <- run_coral(time=time, env=env,pars=pars)

par(mfrow=c(2, 1))
plot_2sh(run)
plot(run$time, run$dH.Hdt, type="l")
# recovery takes ~800 days (not 8000)
```

```{r}
colnames(run)
```

```{r}
jN
rhoC*
jNm
jX
jXm
```

```{r}
plot(run$time, run$dH.Hdt, type="l", ylim=c(min(run$dH.Hdt), 0.1), ylab="d/dt")
lines(run$time, run$dS.Sdt.1, col="red")
lines(run$time, run$dS.Sdt.2, col="blue")
legend("topright", legend=c("H", "S1", "S2"), col=c("black", "red", "blue"), lty=1, bty="n")

par(mfrow=c(3, 2))

plot(run$time, run$rhoN, type="l")

plot(run$time, run$rCH, type="l")

plot(run$time, run$jCO2, type="l")

plot(run$time, run$jeC, type="l")

plot(run$time, run$jHG, type="l")


par(mfrow=c(3,3))

plot(run$time, run$jL.1, type="l")
lines(run$time, run$jL.2, col="red")


plot(run$time, run$jCP.1, type="l")
lines(run$time, run$jCP.2, col="red")

plot(run$time, run$jeL.1, type="l")
lines(run$time, run$jeL.2, col="red")

plot(run$time, run$jNPQ.1, type="l")
lines(run$time, run$jNPQ.2, col="red")

plot(run$time, run$jSG.1, type="l")
lines(run$time, run$jSG.2, col="red")

plot(run$time, run$rhoC.1, type="l")
lines(run$time, run$rhoC.2, col="red")

plot(run$time, run$jST.1, type="l")
lines(run$time, run$jST.2, col="red")

plot(run$time, run$rCS.1, type="l")
lines(run$time, run$rCS.2, col="red")

plot(run$time, run$cROS.1, type="l")
lines(run$time, run$cROS.2, col="red")


```

```{r}
plot(run$time, run$rhoC.1, type="l", xlim=c(0, 900), ylim=c(0, 0.1))
lines(run$time, run$rhoC.2, col="red")
```

### One symbiont case. Host growth rate remains negative (probably dies)

```{r}
##### Define simulation environment
time <- seq(1,3000,0.1)
env <- init_env(time=time, X=c(0,0,0), N=c(5e-7,5e-7,0), L=c(15,15,0))

pars <- def_pars(nsym=1)
pars$initS <- 1e-4

# Run simulations with sensitive or tolerant symbiont
run1s <- run_coral(time=time, env=env, pars=pars)

par(mfrow=c(2, 2))
plot(time, run1s$S/run1s$H, type="l")
plot(time, run1s$dH.Hdt, type="l")
plot(time, run1s$dH.Hdt, type="l", ylim=c(-0.1, 0.1))
```

```{r}
plot(run$time, run$rhoC.1, type="l", xlim=c(0, 900), ylim=c(-0.1, 0.1))
lines(run$time, run$rhoC.2, col="red")
lines(run1s$time, run1s$rhoC, col="blue")
```

```{r}
run$dH.Hdt[length(run$dH.Hdt)]
```

```{r}
plot(run$time, run$dH.Hdt, type="l", ylim=c(min(run$dH.Hdt), 0.1), ylab="d/dt")
lines(run$time, run$dS.Sdt, col="red")
legend("topright", legend=c("H", "S"), col=c("black", "red"), lty=1, bty="n")

par(mfrow=c(3, 2))

plot(run$time, run$rhoN, type="l")

plot(run$time, run$rCH, type="l")

plot(run$time, run$jCO2, type="l")

plot(run$time, run$jeC, type="l")

plot(run$time, run$jHG, type="l")


par(mfrow=c(3,3))

plot(run$time, run$jL, type="l")

plot(run$time, run$jCP, type="l")

plot(run$time, run$jeL, type="l")

plot(run$time, run$jNPQ, type="l")

plot(run$time, run$jSG, type="l")

plot(run$time, run$rhoC, type="l")

plot(run$time, run$jST, type="l")

plot(run$time, run$rCS, type="l")

plot(run$time, run$cROS, type="l")

```

# Do similar parameter combinations produce the same effect?


## One-symbiont case

```{r}
inputDF <- expand.grid("L"=seq(10, 20, 1), "N"=seq(1e-7, 10e-7, 1e-7), "initSH" = c(1e-1, 1e-2, 1e-3, 1e-4, 1e-5))

time<-seq(1, 3000, 0.1)
pars <- def_pars(nsym=1)

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

initSHsweepOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(inputDF[i, "L"], inputDF[i, "L"], 0), N=c(inputDF[i, "N"], inputDF[i, "N"], 0), X=c(0, 0, 0))
    modifiedPars <- pars
    modifiedPars$initS <- inputDF[i, "initSH"]
   
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- run$S[length(run$S)] / run$H[length(run$H)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], 
         "gr"=gr, "finalSH"=finalSH,
         "changeH"=changeH, "changeS"=changeS)
}

stopCluster(cl)
print(proc.time() - start)
initSHsweep <- data.frame(initSHsweepOutput, row.names=NULL)
```

### All simultions equilibrate

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

### Host growth rate

```{r}
par(mfrow=c(2, 3), pty="s", mai=c(0,0,1,0))

for (initSH in c(1e-1, 1e-2, 1e-3, 1e-4, 1e-5)) {
    data <- initSHsweep$gr[initSHsweep$initSH==initSH]
    mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(initSHsweep$L), unique(initSHsweep$N)))
    mat <- mat[nrow(mat):1,]
    
    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (mat[[i, j]] <= 0) {
                mat[[i, j]] <- NA
            }
        }
    }
    
    colmax = max(as.numeric(initSHsweep$gr))
    colbreak = colmax/10
    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="lightgray", na.print=FALSE,
         breaks=seq(0, colmax, colbreak), col=viridis(10),
         key=NULL, fmt.cell='%.2f') 
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

## Two symbiont case

```{r}
inputDF <- expand.grid("L"=seq(10, 20, 1), "N"=seq(1e-7, 10e-7, 1e-7), "initSH" = c(1e-1, 1e-2, 1e-3, 1e-4, 1e-5))

time<-seq(1, 3000, 0.1)
pars <- def_pars(nsym=2)
pars$jCPm[2] <- 1.0
pars$kROS[2] <- 250
pars$jSGm[2] <- 0.15

cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

start <- proc.time()

twoSymbsOutput <- foreach(i=1:nrow(inputDF), .combine='rbind', .packages='dplyr') %dopar% {
    env <- coRal::init_env(time=time, L=c(inputDF[i, "L"], inputDF[i, "L"], 0), N=c(inputDF[i, "N"], inputDF[i, "N"], 0), X=c(0, 0, 0))
    modifiedPars <- pars
    modifiedPars$initS[1:2] <- c(0.5, 0.5)*inputDF[i, "initSH"]
   
    run <- coRal::run_coral(time=time, env=env, pars=modifiedPars)
    gr <- run$dH.Hdt[length(run$dH.Hdt)]
    finalSH <- (run$S.1[length(run$S.1)] + run$S.2[length(run$S.2)]) / run$H[length(run$H)]
    finalST <- run$S.1[length(run$S.1)]/run$S.2[length(run$S.2)]
    
    
    changeH <- ifelse(abs(run$dH.Hdt[length(run$dH.Hdt)] - run$dH.Hdt[length(run$dH.Hdt)-100]) < 0.00001, T, F)
    changeS1 <- ifelse(abs(run$dS.Sdt.1[length(run$dS.Sdt.1)] - run$dS.Sdt.1[length(run$dS.Sdt.1)-100]) < 0.00001, T, F)
    changeS2 <- ifelse(abs(run$dS.Sdt.2[length(run$dS.Sdt.2)] - run$dS.Sdt.2[length(run$dS.Sdt.2)-100]) < 0.00001, T, F)
    
    list("L"=inputDF[i, "L"], "N"=inputDF[i, "N"], "initSH"=inputDF[i, "initSH"], 
         "gr"=gr, "finalSH"=finalSH, "finalST"=finalST,
         "changeH"=changeH, "changeS1"=changeS1, "changeS2"=changeS2)
}

stopCluster(cl)
print(proc.time() - start)
twoSymbs <- data.frame(twoSymbsOutput, row.names=NULL)
```

```{r}

```

### All simultions equilibrate

```{r}
all(as.logical(twoSymbs$changeH))
all(as.logical(twoSymbs$changeS1))
all(as.logical(twoSymbs$changeS2))
```

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

### Host growth rate

```{r}
par(mfrow=c(2, 3), pty="s", mai=c(0,0,1,0))

for (initSH in c(1e-1, 1e-2, 1e-3, 1e-4, 1e-5)) {
    data <- twoSymbs$gr[(twoSymbs$initSH==initSH)]
    mat <- matrix(as.numeric(data), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
    mat <- mat[nrow(mat):1,]

    colmax = max(as.numeric(twoSymbs$gr))
    colbreak = colmax/10
    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="lightgray", na.print=FALSE,
         breaks=seq(0, colmax, colbreak), col=viridis(10),
         key=NULL, fmt.cell='%.2f') 
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c(paste(round(seq(0, colmax-colbreak, colbreak),2), round(seq(colbreak, colmax, colbreak),2), sep=" to "), "gr <= 0"), 
       fill=c(viridis(10), "lightgray"), 
                       title="Host growth rate", cex=1.33, ncol=2)
```

### Sensitive:tolerant symbiont ratio

```{r}
c(min(as.numeric(twoSymbs$gr)), max(as.numeric(twoSymbs$gr)))
```

```{r}
par(mfrow=c(2, 3), pty="s", mai=c(0,0,1,0))

for (initSH in c(1e-1, 1e-2, 1e-3, 1e-4, 1e-5)) {
    growth <- twoSymbs$gr[(twoSymbs$initSH==initSH)]
    data <- twoSymbs$finalST[(twoSymbs$initSH==initSH)]

    growthmat <- matrix(as.numeric(growth), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
    growthmat <- growthmat[nrow(growthmat):1,]
    mat <- matrix(log10(as.numeric(data)), nrow=11, dimnames = list(unique(twoSymbs$L), unique(twoSymbs$N)))
    mat <- mat[nrow(mat):1,]

    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (is.na(growthmat[[i, j]]) || growthmat[[i, j]] < 0) {
                mat[[i, j]] <- NA
            }
        }
    }

    plot(mat, xlab="N", ylab="L", main=paste("Initial S:H =", initSH), na.col="gray",
     breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000), col=brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"),
     key=NULL, fmt.cell='%.2f')
}
plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("top", legend=c("-1000 to -100", "-100 to -10", "-10 to -1", "-1 to 0", "0 to 1", "1 to 10", "10 to 100", "100 to 1000", "gr <= 0"), 
       fill=c(brewer.pal(length(c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))-1,"RdBu"), "gray"),
      title="log10 S:T ratio", cex=1.33, ncol=2)
```

# What about different tolerant symbiont parameters?

```{r}
##### Define simulation environment
time <- seq(1,6000,0.1)
env <- init_env(time=time, X=c(0,0,0), N=c(5e-7,5e-7,0), L=c(15,15,0))

pars1 <- def_pars(nsym=2)
pars1$initS[1:2] <- 0.5e-4

pars2 <- pars1
pars3 <- pars1

pars1$jCPm[2] <- 1.0
pars2$kROS[2] <- 250
pars3$jSGm[2] <- 0.15


run1 <- run_coral(time=time, env=env,pars=pars1)
run2 <- run_coral(time=time, env=env,pars=pars2)
run3 <- run_coral(time=time, env=env,pars=pars3)

par(mfrow=c(3, 2))
plot_2sh(run1)
title("Run 1: S2 jCPm = 1")
plot(run1$time, run1$dH.Hdt, type="l", main="Run 1", ylim=c(-0.1, 0.1))

plot_2sh(run2)
title("Run 2: S2 kROS = 250")
plot(run2$time, run2$dH.Hdt, type="l", main="Run 2", ylim=c(-0.1, 0.1))

plot_2sh(run3)
title("Run 3: S2 jSGm = 0.15")
plot(run3$time, run3$dH.Hdt, type="l", main="Run 3", ylim=c(-0.1, 0.1))
```

```{r}

```
