---
title: "How much tolerant symbiont is needed for rescue?"
author: "Ross Cunning and Alexandra Brown"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
      html_document:
            code_folding: hide
---

```{r setup}
#Set kintr options
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, fig.width=8, fig.height=8, results='hold')

library(coRal)
library(foreach)
library(parallel)
library(doParallel)
library(plot.matrix)
library("RColorBrewer")
library("viridis")
library("MASS")
library("plot3D")
library("adegenet")

options(repr.plot.res=240)

# Load the new run_coral that takes fluxes as inputs
#source("../../coRal2/R/run_coral.R")
```

```{r recovery-ts-fun, cache=TRUE}
# Okay: so I want to find the sens:tol ratio at which tolerant changes from "allows recovery" to "does not allow recovery"
# I know that the sens:tol ratio at which rescue occurred was 1 in the original simulation, and also that there were 0.5e-4 tolerant symbionts per host then

recovery_ts <- function(time, env, pars, totSH, maxTS, minTS, precision=0.1) {

  # Step 1: initialize the minimum and maximum T:S ratio under investigation (this will slowly narrow)
  ts_min <- minTS
  ts_max <- maxTS


  # Step 3: check if positive growth occurs for ts_min and ts_max
  tmp_pars <- pars
  tmp_pars$initS <- c(1, ts_min) * totSH/(1 + ts_min)
  recovery_ts_min <- (coRal::run_coral(time, env, tmp_pars)$dH.Hdt[[length(time)]] > 0)

  tmp_pars <- pars
  tmp_pars$initS <- c(1, ts_max) * totSH/(1 + ts_max)
  recovery_ts_max <- (coRal::run_coral(time, env, tmp_pars)$dH.Hdt[[length(time)]] > 0)


  # Step 4: we need to see negative growth at ts_min and positive growth at ts_max in order to find an intermediate
  # T:S that approximates the T:S ratio at which rescue is no longer possible
  if(recovery_ts_min | !(recovery_ts_max)) {
    if(recovery_ts_min & recovery_ts_max) {
      warning("Minimum T:S: Host is able to recover to positive growth at minimum tolerant:sensitive ratio")
      return(0)
    } else if(!(recovery_ts_min) & !(recovery_ts_max)) {
      warning("Maximum T:S: Host is not able to recover to positive growth at maximum tolerant:sensitive ratio")
      return(Inf)
    } else {
      warning("Min & Max T:S: Host recovers to positive growth at minimum tolerant:sensitive ratio but not at maximum tolerant:sensitive ratio")
      return(NA)
    }
    #return(NA)
  }

  # Step 5: narrow the possible region where we know the transition from T:S being high enough to allow rescue
  # to being too low to allow rescue must occur. (We'll call the point of transition ts_star for ease of commenting)
  while(log(ts_max) - log(ts_min) > precision) {
    # a. find the T:S intermediate between ts_min and ts_max, ts_mid
    ts_mid <- exp((log(ts_min) + log(ts_max))/2)

    # b. check if positive growth occurs post-shock for ts_mid
    tmp_pars <- pars
    tmp_pars$initS <- c(1, ts_mid) * totSH/(1 + ts_mid)
    recovery_ts_mid <- (coRal::run_coral(time, env, tmp_pars)$dH.Hdt[[length(time)]] > 0)

    # c. if positive growth occurs at ts_mid, ts_star must be between ts_mid and ts_min --> set ts_max to ts_mid
    if(recovery_ts_mid) {
      ts_max <- ts_mid
    } else {
    # d. if positive growth does not occur at ts_mid, ts_star must be between ts_max and ts_mid --> set ts_min to ts_mid
      ts_min <- ts_mid
    }
  }

  # Step 6: ts_max and ts_min are now close enough that anywhere between them would be a pretty good approximation for
  # ts_star. So we'll return ts_mid = (ts_max + ts_min)/2 as an approximation of ts_star
  ts_mid <- exp((log(ts_min) + log(ts_max))/2)
  return(ts_mid)
}
```

# Find some environmental conditions under which rescue can occur

```{r rescue-search, cache=TRUE}
# one-symbiont parameters
pars1 <- def_pars(nsym=1)
pars1$initS <- 1e-4

# two-symbiont parameters
pars2 <- coRal::def_pars(nsym=2)
pars2$jCPm[2] <- 1.0 # tolerant symbiont (symbiont 2) has lower max. photosynthetic rate
pars2$kROS[2] <- 250 # tolerant symbiont experiences slower rise in ROS per unit of excess light
pars2$jSGm[2] <- 0.15 # tolerant symbiont has lower max. growth rate
pars2$initS[1:2] <- c(0.5e-4, 0.5e-4)

# run simulations for 100 days to determine survival
survival_time <-seq(0, 100, 0.1)

# run simulations for 1000 days to determine equilibria (if coral survives)
equil_time <- seq(0, 1000, 0.1)

draws = 100000; # number of sets of random parameter combinations to look over

# parameters to search over
search_params <- data.frame(
                            # Environmental parameters
                            "L" = runif(draws, 15, 40),       # Light, choose values between 15 and 40 (where rescue appears to be most likely)
                            "N" = runif(draws, 0, 4e-6),     # DIN, choose values between 0 and 4e-6
                            "X" = runif(draws, 0, 3e-7),     # Food, choose values between 0 and 3e-7
                            "kCO2" = runif(draws, 10, 10))   # kCO2, choose values between 10 and 40

# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# start the timer
start <- proc.time()


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

      # initialize reason; will give the reason for lack of rescue if rescue does not occur
      # reason = "S_lives" -> host recovers with sensitive symbiont alone; does not need to be rescued by tolerant
      # reason = "T_dies" -> tolerant symbiont unable to rescue host
      # reason = "T_dominates" -> tolerant symbiont permits host recovery while sensitive does not, but tolerant dominates post-recovery
      # reason = "rescue" -> rescue occurred
      reason <- NA

    # Set up the environmental conditions
    survival_env <- coRal::init_env(time=survival_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    equil_env <- coRal::init_env(time=equil_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    # Check if the sensitive symbiont can survive alone
    run_1symb <- coRal::run_coral(time=survival_time, env=survival_env, pars=replace(pars1, "kCO2", search_params[i, "kCO2"]))

    # if the coral can achieve positive growth with just the sensitive symbiont, the sensitive symbiont doesn't need to be rescued
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] > 0) {
          reason <- "S_lives"
    }

    # only investigate the two-symbiont case if host growth is negative or 0 at the end of the simulation
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] <= 0) {

        run_2symb <- coRal::run_coral(time=survival_time, env=survival_env, pars=replace(pars2, "kCO2", search_params[i, "kCO2"]))

        # if the coral didn't achieve positive growth with both symbionts, then rescue definitely didn't happen
        # set reason to "T_dies"
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] <= 0) {
             reason <- "T_dies"
        }

        # further investigate the case where host growth is positive at the end of the simulation
        if (run_2symb$dH.Hdt[length(run_2symb$dH.Hdt)] > 0) {

             # the sensitive symbiont (S1) has been rescued if it now has higher biomass than the tolerant symbiont (S2) at equilibrium
             # To figure out if this happened, we need to actually run things to equilibrium
             run_2symb_equil <- coRal::run_coral(time=equil_time, env=equil_env, pars=replace(pars2, "kCO2", search_params[i, "kCO2"]))

             # Check that the host and symbiont growth rates have equilibrated
             tend <- length(equil_time)
             dH <- abs(run_2symb_equil[tend - 1, "dH.Hdt"] -  run_2symb_equil[tend, "dH.Hdt"])
             dS1 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.1"] -  run_2symb_equil[tend, "dS.Sdt.1"])
             dS2 <- abs(run_2symb_equil[tend - 1, "dS.Sdt.2"] -  run_2symb_equil[tend, "dS.Sdt.2"])
             equilibrated <- ((dH <= 1e-5) & (dS1 <= 1e-5) & (dS2 <= 1e-5))

             # if things have not equilibrated, we can't know the outcome; set reason to not_equil
             if (equilibrated == FALSE) {
                   reason <- "not_equil"
             }

             # if things have equilibrated and there is more tolerant that sensitive symbiont, set reason to "T_dominates"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] < run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "T_dominates"
             }

             # if things have equilibrated and there is more sensitive that tolerant symbiont, set reason to "rescue"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] > run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "rescue"
             }

             # if things have equilibrated to equal amounts of sensitive and tolerant symbiont (a) this is really weird and
             # (b) set reason to "possible_coexist"
             if (equilibrated & (run_2symb_equil$S.1[length(run_2symb_equil$S.1)] == run_2symb_equil$S.2[length(run_2symb_equil$S.2)])) {
                   reason <- "possible_coexist"
             }
        }
    }

    # return the parameters and whether rescue was successful or not
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"],
    "X"=search_params[i, "X"], "kCO2"=search_params[i, "kCO2"], "reason"=reason)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
rescue_search <- data.frame(results, row.names=NULL)
save(rescue_search, file="rescue_search.RData")

```


```{r rescue-findings, cache=FALSE}
rescue_env <- rescue_search[rescue_search$reason == "rescue", c("L", "N", "X", "kCO2")]
print("Environmental conditions and host KCO2 under which rescue occurs")
print(rescue_env)
```


# Try a bunch of initial S:T ratios; where does recovery from bleaching become impossible?

```{r find-ts-rescue, cache=TRUE}

pars <- def_pars(nsym=2)
pars$kROS[[2]] <- 250
pars$jCPm[[2]] <- 1
pars$jSGm[[2]] <- 0.15


time <- seq(0, 100, 0.1)

ts_required <- rep(NA, length(rescue_env$L))

for (i in 1:length(rescue_env$L)) {
  env <- list(L=rep(rescue_env$L[[i]], length(time)), N=rep(rescue_env$N[[i]], length(time)), X=rep(rescue_env$X[[i]], length(time)))
  ts_required[[i]] <- recovery_ts(time=time, env=env, pars=replace(pars, "kCO2", rescue_env$kCO2[[i]]), 1e-4, 4, 1e-20, 0.01)
}

ts_df <- data.frame(L=unlist(rescue_env$L), N=unlist(rescue_env$N), X=unlist(rescue_env$X),
  kCO2=unlist(rescue_env$kCO2), TS=unlist(ts_required))

rownames(ts_df) <- c()

print(signif(ts_df, 2))

```


```{r plot-ts-rescue, cache=FALSE}

#pdf("rescue_TS_1d.pdf")
par(mfrow=c(2,2), mar=c(5, 6, 4, 2))
plot(ts_df$L, log(ts_df$TS), xlab="Light",
	ylab="log T:S ratio required\nfor rescue-mediated recovery")

plot(ts_df$N, log(ts_df$TS), xlab="Nitrogen",
	ylab="log T:S ratio required\nfor rescue-mediated recovery")

plot(ts_df$X, log(ts_df$TS), xlab="Food",
	ylab="log T:S ratio required\nfor rescue-mediated recovery")
#dev.off()


#pdf("rescue_TS_2d.pdf")
par(mfrow=c(2,2))
plot(ts_df$L, ts_df$N,
	col=rgb(0.5,
		0, ts_df$TS/max(ts_df$TS)), pch=16,
	xlab="Light", ylab="Nitrogen",
	main="T:S ratio required for\nrescue-mediated recovery")


plot(ts_df$L, ts_df$X,
	col=rgb(0.5,
		0, ts_df$TS/max(ts_df$TS)), pch=16,
	xlab="Light", ylab="Food",
	main="T:S ratio required for\nrescue-mediated recovery")


plot(ts_df$N, ts_df$X,
	col=rgb(0.5,
		0, ts_df$TS/max(ts_df$TS)), pch=16,
	xlab="Nitrogen", ylab="Food",
	main="T:S ratio required for\nrescue-mediated recovery")


legend("bottomright",
	legend=c(0, 0.5*max(ts_df$TS), max(ts_df$TS)),
	col=c(rgb(0.5, 0, 0), rgb(0.5, 0, 0.5), rgb(0.5, 0, 1)), pch=16)
#dev.off()
```

# Check that under "rescue" conditions hosts can recover with the tolerant symbiont alone

```{r recovery-tolerant-alone}

pars <- def_pars(nsym=1)
pars$kROS <- 250
pars$jCPm <- 1
pars$jSGm <- 0.15
pars$initS <- 1e-4


time <- seq(0, 110, 0.1)

tol_recovery100 <- rep(NA, length(rescue_env$L))
tol_recovery110 <- rep(NA, length(rescue_env$L))

for (i in 1:length(rescue_env$L)) {
  env <- list(L=rep(rescue_env$L[[i]], length(time)), N=rep(rescue_env$N[[i]], length(time)), X=rep(rescue_env$X[[i]], length(time)))

  run <- coRal::run_coral(time=time, env=env, pars=replace(pars, "kCO2", rescue_env$kCO2[[i]]))

  tol_recovery100[[i]] <- (run$dH.Hdt[[length(seq(0, 100, 0.1))]] > 0)

  tol_recovery110[[i]] <- (run$dH.Hdt[[length(time)]] > 0)
}

print(paste("Fraction of hosts that recover with tolerant alone? (rescue cases, after 100 days)", sum(tol_recovery100)/length(tol_recovery100)))
print(paste("Fraction of hosts that recover with tolerant alone? (rescue cases, after 110 days)", sum(tol_recovery110)/length(tol_recovery110)))


```


```{r recovery-sensitive-alone}

pars <- def_pars(nsym=1)
pars$initS <- 1e-4


time <- seq(0, 110, 0.1)

tol_recovery100 <- rep(NA, length(rescue_env$L))
tol_recovery110 <- rep(NA, length(rescue_env$L))

for (i in 1:length(rescue_env$L)) {
  env <- list(L=rep(rescue_env$L[[i]], length(time)), N=rep(rescue_env$N[[i]], length(time)), X=rep(rescue_env$X[[i]], length(time)))

  run <- coRal::run_coral(time=time, env=env, pars=replace(pars, "kCO2", rescue_env$kCO2[[i]]))

  tol_recovery100[[i]] <- (run$dH.Hdt[length(seq(0, 100, 0.1))] > 0)

  tol_recovery110[[i]] <- (run$dH.Hdt[[length(time)]] > 0)
}

print(paste("Fraction of hosts that recover with sensitive alone? (rescue cases, after 100 days) should be 0", sum(tol_recovery100)/length(tol_recovery100)))
print(paste("Fraction of hosts that recover with sensitive alone? (rescue cases, after 110 days)", sum(tol_recovery110)/length(tol_recovery110)))


```

# Where can tolerant symbionts survive?

```{r tolerant-survival, cache=TRUE}

# two-symbiont parameters
parsT <- coRal::def_pars(nsym=1)
parsT$jCPm <- 1.0 # tolerant symbiont has lower max. photosynthetic rate
parsT$kROS <- 250 # tolerant symbiont experiences slower rise in ROS per unit of excess light
parsT$jSGm <- 0.15 # tolerant symbiont has lower max. growth rate
parsT$initS <- 1e-4

# run simulations for 100 days to determine survival
survival_time <-seq(0, 100, 0.1)


# set up for parallel run
cl <- makeCluster(detectCores() - 1)
registerDoParallel(cl)

# start the timer
start <- proc.time()


# results will hold the parameter values tested as well as whether the tolerant symbiont "rescued"
# the sensitive symbiont at each parameter value

T_results <- foreach(i=1:nrow(search_params), .combine='rbind', .packages='dplyr') %dopar% {

    # Set up the environmental conditions
    survival_env <- coRal::init_env(time=survival_time, L=c(search_params[i, "L"], search_params[i, "L"], 0),
                           N=c(search_params[i, "N"], search_params[i, "N"], 0), X=c(search_params[i, "X"], search_params[i, "X"], 0))

    # Check if the sensitive symbiont can survive alone
    run_1symb <- coRal::run_coral(time=survival_time, env=survival_env, pars=replace(parsT, "kCO2", search_params[i, "kCO2"]))

    # if the coral can achieve positive growth with just the sensitive symbiont, the sensitive symbiont doesn't need to be rescued
    if (run_1symb$dH.Hdt[length(run_1symb$dH.Hdt)] > 0) {
          tsurvival <- TRUE
    } else {
      tsurvival <- FALSE
    }

    # return the parameters and whether rescue was successful or not
    list("L"=search_params[i, "L"], "N"=search_params[i, "N"],
    "X"=search_params[i, "X"], "kCO2"=search_params[i, "kCO2"], "tsurvival"=tsurvival)
}

stopCluster(cl) # stop the cluster

# store results in dataframe
talone_df <- data.frame(T_results, row.names=NULL)
```

```{r}
salone <- rescue_search[rescue_search$reason=="S_lives",]
talone <- talone_df[talone_df$tsurvival==TRUE,]

par(mfrow=c(2,2))

plot(salone$L, salone$N, pch=20, col="#648FFF20", xlab="Light", ylab="Nitrogen")
points(talone$L, talone$N, pch=20, col="#FFB08020")

plot(salone$L, salone$X, pch=20, col="#648FFF20", xlab="Light", ylab="Food")
points(talone$L, talone$X, pch=20, col="#FFB08020")

plot(salone$N, salone$X, pch=20, col="#648FFF20", xlab="Nitrogen", ylab="Food")
points(talone$N, talone$X, pch=20, col="#FFB08020")

plot(NULL, xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("center", c("Sensitive symb. survives alone", "Tolerant symb. survives alone"), col=c("#648FFF", "#FFB080"), pch=c(20, 20))



```

# Sample plot of high light region where host recovers with S but not T

```{r}

df <- data.frame(L=unlist(setdiff(salone$L, talone$L)),
	N=unlist(setdiff(salone$N, talone$N)),
	X=unlist(setdiff(salone$X, talone$X)))
	#kCO2=unlist(setdiff(salone$kCO2, talone$kCO2)))


myL <- df[df$L > 36,][94,]$L
myX <- df[df$L > 36,][94,]$X
myN <- df[df$L > 36,][94,]$N

time <- seq(0, 300, 0.1)
env <- init_env(time, L=c(myL, myL, 0), N=c(myN, myN, 0), X=c(myX, myX, 0))

srun <- run_coral(time=time, pars=pars1, env=env)
trun <- run_coral(time=time, pars=parsT, env=env)

png("test.png")
par(mfrow=c(2,1))
plot(srun$time, srun$S/srun$H, type="l", col="blue", ylim=c(0, 0.2))
lines(trun$time, trun$S/trun$H, col="orange")

plot(srun$time, srun$dH.Hdt, type="l", col="blue", ylim=c(-0.05, 0.05))
lines(trun$time, trun$dH.Hdt, col="orange")
dev.off()

```
